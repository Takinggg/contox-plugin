{
  "version": 3,
  "sources": ["../src/extension.ts", "../src/api/client.ts", "../src/providers/context-tree.ts", "../src/providers/status-bar.ts", "../src/providers/session-watcher.ts", "../src/providers/git-watcher.ts", "../src/commands/login.ts", "../src/commands/init.ts", "../src/commands/sync.ts", "../src/commands/create.ts", "../src/commands/setup-wizard.ts", "../src/lib/mcp-deployer.ts", "../src/commands/reset.ts", "../src/commands/load-memory.ts", "../src/lib/inject-rules.ts", "../src/commands/end-session.ts", "../src/commands/desync.ts", "../src/providers/context-injector.ts"],
  "sourcesContent": ["import * as vscode from 'vscode';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\nimport { ContoxClient } from './api/client';\r\nimport { ContextTreeProvider } from './providers/context-tree';\r\nimport { StatusBarManager } from './providers/status-bar';\r\nimport { SessionWatcher } from './providers/session-watcher';\r\nimport { GitWatcher } from './providers/git-watcher';\r\nimport { registerLoginCommand } from './commands/login';\r\nimport { registerInitCommand } from './commands/init';\r\nimport { registerSyncCommand } from './commands/sync';\r\nimport { registerCreateCommand } from './commands/create';\r\nimport { registerSetupWizardCommand, openSetupWizard } from './commands/setup-wizard';\r\nimport { registerResetCommand } from './commands/reset';\r\nimport { registerLoadMemoryCommand, loadMemorySilent } from './commands/load-memory';\r\nimport { registerEndSessionCommand } from './commands/end-session';\r\nimport { registerDesyncCommand, registerConnectCommand, isDesynced } from './commands/desync';\r\nimport { ContextInjector } from './providers/context-injector';\r\nimport { deployMcpServer } from './lib/mcp-deployer';\r\nimport { configureAllMcp } from './commands/setup-wizard';\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * Workspace configuration stored in .contox.json\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\nexport interface ContoxWorkspaceConfig {\r\n  teamId: string;\r\n  projectId: string;\r\n  projectName: string;\r\n}\r\n\r\n/**\r\n * Read .contox.json from the first workspace folder.\r\n * Returns null when no workspace is open or the config is missing / invalid.\r\n */\r\nexport function getWorkspaceConfig(): ContoxWorkspaceConfig | null {\r\n  const workspaceFolders = vscode.workspace.workspaceFolders;\r\n  if (!workspaceFolders || workspaceFolders.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  const rootPath = workspaceFolders[0]!.uri.fsPath;\r\n  const configPath = path.join(rootPath, '.contox.json');\r\n\r\n  try {\r\n    const raw = fs.readFileSync(configPath, 'utf-8');\r\n    const parsed = JSON.parse(raw) as Record<string, unknown>;\r\n\r\n    const teamId = parsed['teamId'];\r\n    const projectId = parsed['projectId'];\r\n    const projectName = parsed['projectName'];\r\n\r\n    if (typeof teamId === 'string' && typeof projectId === 'string') {\r\n      return {\r\n        teamId,\r\n        projectId,\r\n        projectName: typeof projectName === 'string' ? projectName : 'Unknown',\r\n      };\r\n    }\r\n    return null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * URI Handler \u2014 Deep links from the Contox dashboard\r\n *\r\n * Handles: vscode://contox.contox-vscode/setup?token=xxx&teamId=xxx&projectId=xxx\r\n * Auto-configures the extension without manual setup.\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\nclass ContoxUriHandler implements vscode.UriHandler {\r\n  constructor(\r\n    private readonly client: ContoxClient,\r\n    private readonly treeProvider: ContextTreeProvider,\r\n    private readonly statusBar: StatusBarManager,\r\n    private readonly sessionWatcher: SessionWatcher,\r\n    private readonly gitWatcher: GitWatcher,\r\n    private readonly context: vscode.ExtensionContext,\r\n    private readonly mcpReady: Promise<string | void>,\r\n  ) {}\r\n\r\n  async handleUri(uri: vscode.Uri): Promise<void> {\r\n    const params = new URLSearchParams(uri.query);\r\n    const token = params.get('token');\r\n    const teamId = params.get('teamId');\r\n    const projectId = params.get('projectId');\r\n    const projectName = params.get('projectName');\r\n\r\n    if (uri.path === '/setup' && token) {\r\n      await this.handleSetup(token, teamId, projectId, projectName);\r\n    } else if (uri.path === '/desync') {\r\n      await vscode.commands.executeCommand('contox.desync');\r\n    } else if (uri.path === '/connect') {\r\n      await vscode.commands.executeCommand('contox.connect');\r\n    }\r\n  }\r\n\r\n  private async handleSetup(\r\n    token: string,\r\n    teamId: string | null,\r\n    projectId: string | null,\r\n    projectName: string | null,\r\n  ): Promise<void> {\r\n    // 1. Store the API key\r\n    await this.client.setApiKey(token);\r\n\r\n    // 2. Fetch HMAC secret securely via API (not from deep link URL)\r\n    let hmacSecret: string | null = null;\r\n    if (projectId) {\r\n      try {\r\n        const result = await this.client.getProjectHmacSecret(projectId);\r\n        if (result.data?.hmacSecret) {\r\n          hmacSecret = result.data.hmacSecret;\r\n          await this.context.secrets.store('contox-hmac-secret', hmacSecret);\r\n        }\r\n      } catch {\r\n        console.warn('Contox: Failed to fetch HMAC secret \u2014 git capture will retry later');\r\n      }\r\n    }\r\n\r\n    // 3. If projectId provided, auto-configure workspace\r\n    if (teamId && projectId) {\r\n      await this.autoConfigureProject(token, teamId, projectId, projectName ?? 'Project', hmacSecret);\r\n    } else if (teamId) {\r\n      // teamId only \u2192 show project picker\r\n      await this.showProjectPicker(teamId);\r\n    } else {\r\n      // Token only \u2192 open setup wizard for project selection\r\n      void vscode.window.showInformationMessage(\r\n        '$(check) Contox: Authenticated! Choose a project to get started.',\r\n        'Open Setup',\r\n      ).then((action) => {\r\n        if (action === 'Open Setup') {\r\n          openSetupWizard(this.client, this.treeProvider, this.statusBar, this.context);\r\n        }\r\n      });\r\n      return;\r\n    }\r\n  }\r\n\r\n  private async autoConfigureProject(\r\n    token: string,\r\n    teamId: string,\r\n    projectId: string,\r\n    projectName: string,\r\n    hmacSecret?: string | null,\r\n  ): Promise<void> {\r\n    const workspaceFolders = vscode.workspace.workspaceFolders;\r\n    if (!workspaceFolders || workspaceFolders.length === 0) {\r\n      void vscode.window.showWarningMessage(\r\n        'Contox: Open a workspace folder first, then try again.',\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Write .contox.json\r\n    const rootPath = workspaceFolders[0]!.uri.fsPath;\r\n    const configPath = path.join(rootPath, '.contox.json');\r\n    const config = { teamId, projectId, projectName };\r\n    fs.writeFileSync(configPath, JSON.stringify(config, null, 2) + '\\n', 'utf-8');\r\n\r\n    // Write ~/.contoxrc for CLI auth (includes hmacSecret for CLI V2 ingest)\r\n    try {\r\n      const rcPath = path.join(require('os').homedir(), '.contoxrc');\r\n      const apiUrl = vscode.workspace.getConfiguration('contox').get<string>('apiUrl', 'https://contox.dev');\r\n      const rcConfig: Record<string, string> = {\r\n        apiKey: token,\r\n        apiUrl,\r\n        teamId,\r\n        projectId,\r\n      };\r\n      if (hmacSecret) { rcConfig['hmacSecret'] = hmacSecret; }\r\n      fs.writeFileSync(rcPath, JSON.stringify(rcConfig, null, 2) + '\\n', { encoding: 'utf-8', mode: 0o600 });\r\n    } catch {\r\n      // Non-critical\r\n    }\r\n\r\n    // Configure MCP server for all AI tools (Claude, Cursor, Copilot, Windsurf)\r\n    const apiUrl = vscode.workspace.getConfiguration('contox').get<string>('apiUrl', 'https://contox.dev');\r\n    try {\r\n      await this.mcpReady;\r\n      configureAllMcp(token, apiUrl, teamId, projectId, rootPath, hmacSecret ?? undefined, this.context);\r\n    } catch (err) {\r\n      console.error('Contox: Failed to configure MCP:', err);\r\n    }\r\n\r\n    // Start watchers\r\n    this.sessionWatcher.start(projectId);\r\n    this.gitWatcher.start(projectId);\r\n\r\n    // Sync contexts + load memory into .contox/memory.md + inject AI rules\r\n    await vscode.commands.executeCommand('contox.sync');\r\n    void loadMemorySilent(this.client, rootPath, projectId);\r\n\r\n    void vscode.window.showInformationMessage(\r\n      `$(check) Contox: Connected to \"${projectName}\" \u2014 memory loaded for all AI tools`,\r\n    );\r\n  }\r\n\r\n  private async showProjectPicker(teamId: string): Promise<void> {\r\n    const result = await this.client.listProjects(teamId);\r\n    if (result.error || !result.data) {\r\n      void vscode.window.showErrorMessage(`Contox: Failed to load projects \u2014 ${result.error ?? 'unknown error'}`);\r\n      return;\r\n    }\r\n\r\n    const projects = result.data;\r\n    if (projects.length === 0) {\r\n      void vscode.window.showWarningMessage('Contox: No projects found for this team. Create one on the dashboard first.');\r\n      return;\r\n    }\r\n\r\n    const pick = await vscode.window.showQuickPick(\r\n      projects.map((p) => ({\r\n        label: p.name,\r\n        description: p.description ?? '',\r\n        detail: `${p.contextsCount} contexts`,\r\n        projectId: p.id,\r\n      })),\r\n      { placeHolder: 'Choose a project' },\r\n    );\r\n\r\n    if (pick) {\r\n      const token = await this.client.getApiKey();\r\n      if (token) {\r\n        await this.autoConfigureProject(token, teamId, pick.projectId, pick.label, null);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * Extension lifecycle\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\nexport function activate(context: vscode.ExtensionContext): void {\r\n  // Deploy MCP server to globalStorage (fire-and-forget, awaited before setup/deep link)\r\n  const mcpReady = deployMcpServer(context).catch((err) => {\r\n    console.error('Contox: Failed to deploy MCP server:', err);\r\n  });\r\n\r\n  const client = new ContoxClient(context.secrets);\r\n  const treeProvider = new ContextTreeProvider(client);\r\n  const statusBar = new StatusBarManager();\r\n  const sessionWatcher = new SessionWatcher(client, statusBar);\r\n  const gitWatcher = new GitWatcher(client, statusBar, context.secrets);\r\n  const contextInjector = new ContextInjector(client);\r\n  sessionWatcher.setGitWatcher(gitWatcher);\r\n\r\n  // Register the tree view in the activity-bar panel\r\n  const treeView = vscode.window.createTreeView('contoxContexts', {\r\n    treeDataProvider: treeProvider,\r\n    showCollapseAll: false,\r\n  });\r\n\r\n  // Flag to skip auto-init when activated by a deep link (URI handler will handle setup)\r\n  let handledByUri = false;\r\n\r\n  // Register URI handler for deep links from dashboard\r\n  const uriHandler = new ContoxUriHandler(client, treeProvider, statusBar, sessionWatcher, gitWatcher, context, mcpReady);\r\n  const originalHandleUri = uriHandler.handleUri.bind(uriHandler);\r\n  uriHandler.handleUri = async (uri: vscode.Uri): Promise<void> => {\r\n    handledByUri = true;\r\n    return originalHandleUri(uri);\r\n  };\r\n\r\n  // Register all commands\r\n  context.subscriptions.push(\r\n    registerLoginCommand(client),\r\n    registerInitCommand(client),\r\n    registerSyncCommand(client, treeProvider, statusBar),\r\n    registerCreateCommand(client, treeProvider, statusBar),\r\n    registerSetupWizardCommand(client, treeProvider, statusBar, context),\r\n    registerResetCommand(client),\r\n    registerLoadMemoryCommand(client),\r\n    registerEndSessionCommand(gitWatcher),\r\n    registerDesyncCommand(statusBar, sessionWatcher, gitWatcher, context),\r\n    registerConnectCommand(client, statusBar, sessionWatcher, gitWatcher, context, () => {\r\n      const cfg = getWorkspaceConfig();\r\n      return cfg?.projectId ?? null;\r\n    }),\r\n    vscode.commands.registerCommand('contox.flushCapture', () => {\r\n      void gitWatcher.flush();\r\n    }),\r\n    treeView,\r\n    statusBar,\r\n    sessionWatcher,\r\n    gitWatcher,\r\n    contextInjector,\r\n    vscode.window.registerUriHandler(uriHandler),\r\n  );\r\n\r\n  // Auto-open setup wizard if not configured, otherwise auto-sync + start watcher.\r\n  // Small delay to let the URI handler run first when activated by onUri.\r\n  void (async () => {\r\n    await Promise.all([\r\n      new Promise((r) => { setTimeout(r, 500); }),\r\n      mcpReady,\r\n    ]);\r\n    if (handledByUri) { return; }\r\n\r\n    const key = await client.getApiKey();\r\n    const config = getWorkspaceConfig();\r\n\r\n    const wsFolders = vscode.workspace.workspaceFolders;\r\n    if (key && config && wsFolders && wsFolders.length > 0) {\r\n      // Already configured \u2014 auto-sync + load memory\r\n      await vscode.commands.executeCommand('contox.sync');\r\n      void loadMemorySilent(client, wsFolders[0]!.uri.fsPath, config.projectId);\r\n\r\n      // If user previously desynced, stay disconnected\r\n      if (isDesynced(context)) {\r\n        statusBar.setDisconnected();\r\n        return;\r\n      }\r\n\r\n      // Ensure HMAC secret is available before starting capture\r\n      const hmac = await context.secrets.get('contox-hmac-secret');\r\n      if (!hmac) {\r\n        try {\r\n          const hmacResult = await client.getProjectHmacSecret(config.projectId);\r\n          if (hmacResult.data?.hmacSecret) {\r\n            await context.secrets.store('contox-hmac-secret', hmacResult.data.hmacSecret);\r\n          }\r\n        } catch {\r\n          // Non-critical \u2014 GitWatcher has its own fallback\r\n        }\r\n      }\r\n\r\n      sessionWatcher.start(config.projectId);\r\n      gitWatcher.start(config.projectId);\r\n      contextInjector.start(config.projectId);\r\n\r\n      // Check if MCP is configured for AI tools \u2014 prompt if not\r\n      const rootPath = wsFolders[0]!.uri.fsPath;\r\n      const mcpConfigPath = path.join(rootPath, '.mcp.json');\r\n      let needsMcpSetup = true;\r\n      try {\r\n        const raw = fs.readFileSync(mcpConfigPath, 'utf-8');\r\n        const parsed = JSON.parse(raw) as Record<string, unknown>;\r\n        const servers = parsed['mcpServers'] as Record<string, unknown> | undefined;\r\n        const contox = servers?.['contox'] as Record<string, unknown> | undefined;\r\n        const args = contox?.['args'] as string[] | undefined;\r\n        // Already configured with globalStorage path (not old relative path)\r\n        if (args?.[0] && !args[0].includes('packages/mcp-server')) {\r\n          needsMcpSetup = false;\r\n        }\r\n      } catch {\r\n        // .mcp.json doesn't exist or is invalid\r\n      }\r\n\r\n      if (needsMcpSetup) {\r\n        const action = await vscode.window.showInformationMessage(\r\n          'Contox: Configure MCP server for your AI tools (Claude, Cursor, Copilot, Windsurf)?',\r\n          'Configure',\r\n          'Later',\r\n        );\r\n        if (action === 'Configure') {\r\n          openSetupWizard(client, treeProvider, statusBar, context);\r\n        }\r\n      }\r\n    } else if (vscode.workspace.workspaceFolders && vscode.workspace.workspaceFolders.length > 0) {\r\n      // Workspace open but not configured \u2014 show a subtle prompt\r\n      const action = await vscode.window.showInformationMessage(\r\n        'Contox: Set up AI memory for this project?',\r\n        'Setup',\r\n        'Later',\r\n      );\r\n      if (action === 'Setup') {\r\n        openSetupWizard(client, treeProvider, statusBar, context);\r\n      }\r\n    }\r\n  })();\r\n}\r\n\r\nexport function deactivate(): void {\r\n  // Cleanup is handled by VS Code disposing subscriptions\r\n}\r\n", "import * as crypto from 'crypto';\r\nimport * as vscode from 'vscode';\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * IDE DETECTION \u2014 detect which VS Code fork is running\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\n/** Detect the current IDE from vscode.env.appName */\r\nexport function detectIdeSource(): string {\r\n  const name = vscode.env.appName.toLowerCase();\r\n  if (name.includes('cursor')) { return 'cursor'; }\r\n  if (name.includes('windsurf')) { return 'windsurf'; }\r\n  if (name.includes('antigravity')) { return 'antigravity'; }\r\n  return 'vscode';\r\n}\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * TYPE DEFINITIONS \u2014 matching the real Contox API response shapes\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\nexport interface ContoxContext {\r\n  id: string;\r\n  name: string;\r\n  description: string | null;\r\n  content?: string | null;\r\n  status: string;\r\n  files: number;\r\n  tokens: number;\r\n  lastSynced: string;\r\n  projectId: string | null;\r\n  parentContextId?: string | null;\r\n  createdAt?: string;\r\n  updatedAt: string;\r\n}\r\n\r\nexport interface BrainTreeNode {\r\n  schemaKey: string;\r\n  name: string;\r\n  itemCount: number;\r\n  children: BrainTreeNode[];\r\n}\r\n\r\nexport interface BrainResponse {\r\n  document: string;\r\n  tokenEstimate: number;\r\n  itemsLoaded: number;\r\n  schemaKeys: string[];\r\n  brainHash: string;\r\n  tree: BrainTreeNode[];\r\n}\r\n\r\nexport interface ContoxTeam {\r\n  id: string;\r\n  name: string;\r\n  members: number;\r\n  createdAt: string;\r\n}\r\n\r\nexport interface ContoxProject {\r\n  id: string;\r\n  name: string;\r\n  description: string | null;\r\n  status: string;\r\n  teamId: string;\r\n  contextsCount: number;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nexport interface SearchResult {\r\n  itemId: string;\r\n  type: string;\r\n  title: string;\r\n  facts: string;\r\n  schemaKey: string;\r\n  similarity: number;\r\n  confidence: number;\r\n  files: string[];\r\n}\r\n\r\nexport interface SearchResponse {\r\n  results: SearchResult[];\r\n  query: string;\r\n  totalCandidates: number;\r\n}\r\n\r\nexport interface ContoxSyncResult {\r\n  id: string;\r\n  name: string;\r\n  status: string;\r\n  lastSynced: string;\r\n  updatedAt: string;\r\n}\r\n\r\ninterface ApiResponse<T> {\r\n  data?: T;\r\n  error?: string;\r\n}\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * API CLIENT\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\nexport class ContoxClient {\r\n  private baseUrl: string;\r\n  private apiKey: string | undefined;\r\n\r\n  constructor(private readonly secrets: vscode.SecretStorage) {\r\n    const config = vscode.workspace.getConfiguration('contox');\r\n    this.baseUrl = config.get<string>('apiUrl', 'https://contox.dev');\r\n  }\r\n\r\n  /* \u2500\u2500 API Key management \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  async setApiKey(key: string): Promise<void> {\r\n    this.apiKey = key;\r\n    await this.secrets.store('contox-api-key', key);\r\n  }\r\n\r\n  async getApiKey(): Promise<string | undefined> {\r\n    if (!this.apiKey) {\r\n      this.apiKey = await this.secrets.get('contox-api-key');\r\n    }\r\n    return this.apiKey;\r\n  }\r\n\r\n  async clearApiKey(): Promise<void> {\r\n    this.apiKey = undefined;\r\n    await this.secrets.delete('contox-api-key');\r\n  }\r\n\r\n  /* \u2500\u2500 Generic HTTP helper \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  private async request<T>(path: string, options: RequestInit = {}): Promise<ApiResponse<T>> {\r\n    const key = await this.getApiKey();\r\n    if (!key) {\r\n      return { error: 'Not authenticated. Run \"Contox: Login\" first.' };\r\n    }\r\n\r\n    const url = `${this.baseUrl}/api${path}`;\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        ...options,\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${key}`,\r\n          ...options.headers,\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const body = await response.json().catch(() => ({})) as Record<string, unknown>;\r\n        const message = typeof body['error'] === 'string' ? body['error'] : response.statusText;\r\n        return { error: message };\r\n      }\r\n\r\n      const data = await response.json() as T;\r\n      return { data };\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : 'Unknown error';\r\n      return { error: message };\r\n    }\r\n  }\r\n\r\n  /* \u2500\u2500 Contexts \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  /**\r\n   * List contexts for a project via the VS Code integration endpoint.\r\n   * GET /api/integrations/vscode?projectId=xxx\r\n   * Returns { contexts: ContoxContext[], total: number }\r\n   */\r\n  async listContexts(projectId: string): Promise<ApiResponse<ContoxContext[]>> {\r\n    const all: ContoxContext[] = [];\r\n    let offset = 0;\r\n    const limit = 100;\r\n\r\n    // Paginate through all contexts\r\n    while (true) {\r\n      const result = await this.request<{ contexts: ContoxContext[]; total: number }>(\r\n        `/integrations/vscode?projectId=${encodeURIComponent(projectId)}&limit=${limit}&offset=${offset}`,\r\n      );\r\n      if (result.error) {\r\n        return { error: result.error };\r\n      }\r\n      const batch = result.data?.contexts ?? [];\r\n      all.push(...batch);\r\n\r\n      if (batch.length < limit || all.length >= (result.data?.total ?? 0)) {\r\n        break;\r\n      }\r\n      offset += limit;\r\n    }\r\n\r\n    return { data: all };\r\n  }\r\n\r\n  /** @deprecated Use getBrain() instead */\r\n  async listContextTree(\r\n    _teamId: string,\r\n    projectId: string,\r\n  ): Promise<ApiResponse<BrainResponse>> {\r\n    return this.getBrain(projectId);\r\n  }\r\n\r\n  /**\r\n   * Get a single context with its full content.\r\n   * GET /api/contexts/:id\r\n   */\r\n  async getContext(id: string): Promise<ApiResponse<ContoxContext>> {\r\n    return this.request<ContoxContext>(`/contexts/${encodeURIComponent(id)}`);\r\n  }\r\n\r\n  /**\r\n   * Create a new context.\r\n   * POST /api/contexts \u2014 requires { name, teamId, projectId }\r\n   */\r\n  async createContext(\r\n    name: string,\r\n    teamId: string,\r\n    projectId: string,\r\n    description?: string,\r\n  ): Promise<ApiResponse<ContoxContext>> {\r\n    return this.request<ContoxContext>('/contexts', {\r\n      method: 'POST',\r\n      body: JSON.stringify({ name, teamId, projectId, description }),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update a context (e.g. content, name, description).\r\n   * PATCH /api/contexts/:id\r\n   */\r\n  async updateContext(\r\n    id: string,\r\n    data: { name?: string; description?: string; content?: string },\r\n  ): Promise<ApiResponse<ContoxContext>> {\r\n    return this.request<ContoxContext>(`/contexts/${encodeURIComponent(id)}`, {\r\n      method: 'PATCH',\r\n      body: JSON.stringify(data),\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sync content from VS Code into a context via the dedicated integration endpoint.\r\n   * POST /api/integrations/vscode \u2014 { contextId, content }\r\n   */\r\n  async syncContent(contextId: string, content: string): Promise<ApiResponse<ContoxSyncResult>> {\r\n    return this.request<ContoxSyncResult>('/integrations/vscode', {\r\n      method: 'POST',\r\n      body: JSON.stringify({ contextId, content }),\r\n    });\r\n  }\r\n\r\n  /* \u2500\u2500 Teams \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  /**\r\n   * List teams/organizations the authenticated user belongs to.\r\n   * GET /api/orgs \u2014 returns { orgs: ContoxTeam[] }\r\n   */\r\n  async listTeams(): Promise<ApiResponse<ContoxTeam[]>> {\r\n    const result = await this.request<{ orgs: ContoxTeam[] }>('/orgs');\r\n    if (result.error) {\r\n      return { error: result.error };\r\n    }\r\n    return { data: result.data?.orgs ?? [] };\r\n  }\r\n\r\n  /* \u2500\u2500 Projects \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  /**\r\n   * List projects for an organization (team).\r\n   * GET /api/projects?teamId=xxx \u2014 returns ContoxProject[]\r\n   */\r\n  async listProjects(teamId: string): Promise<ApiResponse<ContoxProject[]>> {\r\n    return this.request<ContoxProject[]>(\r\n      `/projects?teamId=${encodeURIComponent(teamId)}`,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Fetch the per-project HMAC secret for V2 ingest signing.\r\n   * GET /api/projects/:id/hmac-secret\r\n   */\r\n  async getProjectHmacSecret(projectId: string): Promise<ApiResponse<{ hmacSecret: string }>> {\r\n    return this.request<{ hmacSecret: string }>(\r\n      `/projects/${encodeURIComponent(projectId)}/hmac-secret`,\r\n    );\r\n  }\r\n\r\n  /* \u2500\u2500 V2 Brain (project memory) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  /**\r\n   * Fetch the compiled brain document for a project.\r\n   * GET /api/v2/brain?projectId=xxx\r\n   */\r\n  async getBrain(projectId: string): Promise<ApiResponse<BrainResponse>> {\r\n    return this.request<BrainResponse>(\r\n      `/v2/brain?projectId=${encodeURIComponent(projectId)}`,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Semantic search for relevant memory items.\r\n   * GET /api/v2/search?projectId=xxx&q=...&limit=10&minSimilarity=0.5\r\n   */\r\n  async searchMemory(\r\n    projectId: string,\r\n    query: string,\r\n    limit = 10,\r\n  ): Promise<ApiResponse<SearchResponse>> {\r\n    return this.request<SearchResponse>(\r\n      `/v2/search?projectId=${encodeURIComponent(projectId)}&q=${encodeURIComponent(query)}&limit=${limit}&minSimilarity=0.5`,\r\n    );\r\n  }\r\n\r\n  /* \u2500\u2500 V2 Sessions (for save monitoring) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  /**\r\n   * List recent sessions for a project.\r\n   * GET /api/v2/sessions?projectId=xxx&limit=5\r\n   */\r\n  async listSessions(projectId: string, limit = 5): Promise<ApiResponse<V2SessionsResponse>> {\r\n    return this.request<V2SessionsResponse>(\r\n      `/v2/sessions?projectId=${encodeURIComponent(projectId)}&limit=${limit}`,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get jobs for a session (pipeline status).\r\n   * GET /api/v2/sessions/:sessionId/jobs\r\n   */\r\n  async getSessionJobs(sessionId: string): Promise<ApiResponse<V2JobsResponse>> {\r\n    return this.request<V2JobsResponse>(\r\n      `/v2/sessions/${encodeURIComponent(sessionId)}/jobs`,\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Close a session (set status to 'closed').\r\n   * PATCH /api/v2/sessions/:sessionId\r\n   */\r\n  async closeSession(sessionId: string): Promise<ApiResponse<{ ok: boolean; sessionId: string }>> {\r\n    return this.request<{ ok: boolean; sessionId: string }>(\r\n      `/v2/sessions/${encodeURIComponent(sessionId)}`,\r\n      { method: 'PATCH', body: JSON.stringify({ status: 'closed' }) },\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Find the currently active session for a project (if any).\r\n   */\r\n  async getActiveSession(projectId: string): Promise<ApiResponse<V2Session | null>> {\r\n    const result = await this.listSessions(projectId, 5);\r\n    if (result.error) { return { error: result.error }; }\r\n    const active = result.data?.sessions.find((s) => s.status === 'active') ?? null;\r\n    return { data: active };\r\n  }\r\n\r\n  /**\r\n   * Create a new session for a project.\r\n   * POST /api/v2/sessions\r\n   */\r\n  async createSession(projectId: string, source = detectIdeSource()): Promise<ApiResponse<{ ok: boolean; sessionId: string }>> {\r\n    return this.request<{ ok: boolean; sessionId: string }>(\r\n      '/v2/sessions',\r\n      { method: 'POST', body: JSON.stringify({ projectId, source }) },\r\n    );\r\n  }\r\n\r\n  /* \u2500\u2500 V2 Ingest (for auto-capture) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  /**\r\n   * Send captured events to the V2 ingest endpoint.\r\n   * Signs the payload with HMAC-SHA256 and sets skipEnrichment=true\r\n   * so enrichment is deferred to user action in the Dashboard Inbox.\r\n   *\r\n   * POST /api/v2/ingest\r\n   */\r\n  async ingestEvents(\r\n    projectId: string,\r\n    event: VsCodeCaptureEvent,\r\n    hmacSecret: string,\r\n  ): Promise<ApiResponse<IngestResponse>> {\r\n    const eventPayload = JSON.stringify(event);\r\n    const timestamp = new Date().toISOString();\r\n    const nonce = crypto.randomBytes(16).toString('hex');\r\n    const signature = crypto\r\n      .createHmac('sha256', hmacSecret)\r\n      .update(eventPayload)\r\n      .digest('hex');\r\n\r\n    const body = {\r\n      source: detectIdeSource(),\r\n      timestamp,\r\n      nonce,\r\n      signature,\r\n      projectId,\r\n      event,\r\n      skipEnrichment: true,\r\n    };\r\n\r\n    const key = await this.getApiKey();\r\n    if (!key) {\r\n      return { error: 'Not authenticated. Run \"Contox: Login\" first.' };\r\n    }\r\n\r\n    const url = `${this.baseUrl}/api/v2/ingest`;\r\n\r\n    try {\r\n      const response = await fetch(url, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Authorization': `Bearer ${key}`,\r\n        },\r\n        body: JSON.stringify(body),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const respBody = await response.json().catch(() => ({})) as Record<string, unknown>;\r\n        const message = typeof respBody['error'] === 'string' ? respBody['error'] : response.statusText;\r\n        return { error: message };\r\n      }\r\n\r\n      const data = await response.json() as IngestResponse;\r\n      return { data };\r\n    } catch (err) {\r\n      const message = err instanceof Error ? err.message : 'Unknown error';\r\n      return { error: message };\r\n    }\r\n  }\r\n}\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * V2 Types\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\nexport interface V2Session {\r\n  id: string;\r\n  projectId: string;\r\n  startedAt: string;\r\n  status: string;\r\n  source: string | null;\r\n  messageCount: number;\r\n  summary: string | null;\r\n  updatedAt: string;\r\n}\r\n\r\nexport interface V2SessionsResponse {\r\n  sessions: V2Session[];\r\n  total: number;\r\n}\r\n\r\nexport interface V2Job {\r\n  id: string;\r\n  jobType: string;\r\n  status: string;\r\n  attempts: number;\r\n  lastError: string | null;\r\n  createdAt: string;\r\n  processedAt: string | null;\r\n}\r\n\r\nexport interface V2PipelineSummary {\r\n  totalSteps: number;\r\n  completedSteps: number;\r\n  failedSteps: number;\r\n  status: 'pending' | 'running' | 'done' | 'failed';\r\n}\r\n\r\nexport interface V2JobsResponse {\r\n  jobs: V2Job[];\r\n  pipeline: V2PipelineSummary;\r\n}\r\n\r\n/* \u2500\u2500 V2 Ingest types \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\nexport interface VsCodeCaptureCommit {\r\n  sha: string;\r\n  message: string;\r\n  author: string;\r\n  timestamp: string;\r\n  filesChanged: string[];\r\n  insertions: number;\r\n  deletions: number;\r\n  /** Compact diff context (max 2000 chars). Populated when contox.capture.includeDiffs is true. */\r\n  diff?: string;\r\n}\r\n\r\nexport interface VsCodeCaptureEvent {\r\n  type: 'vscode_capture';\r\n  commits: VsCodeCaptureCommit[];\r\n  filesModified: string[];\r\n  sessionDurationMs: number;\r\n  activeEditorFiles?: string[];\r\n}\r\n\r\nexport interface IngestResponse {\r\n  eventId: string;\r\n  sessionId: string;\r\n  status: 'accepted';\r\n  blobIds?: string[];\r\n  enrichmentJobId?: string;\r\n  enrichmentPending?: boolean;\r\n}\r\n", "import * as vscode from 'vscode';\nimport type { ContoxClient, BrainTreeNode } from '../api/client';\n\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * Tree item representing a single V2 brain node (schemaKey group)\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\n\nconst SCHEMA_ICONS: Record<string, string> = {\n  'root/decisions': 'lightbulb',\n  'root/conventions': 'list-ordered',\n  'root/architecture': 'server',\n  'root/journal': 'notebook',\n  'root/bugs': 'bug',\n  'root/todo': 'checklist',\n  'root/codemap': 'file-code',\n  'root/stack': 'layers',\n  'root/frontend': 'browser',\n  'root/backend': 'server-process',\n};\n\nfunction nodeIcon(node: BrainTreeNode): vscode.ThemeIcon {\n  const icon = SCHEMA_ICONS[node.schemaKey];\n  if (icon) { return new vscode.ThemeIcon(icon); }\n  if (node.children.length > 0) { return new vscode.ThemeIcon('symbol-namespace'); }\n  return new vscode.ThemeIcon('symbol-field');\n}\n\nexport class ContextItem extends vscode.TreeItem {\n  public readonly node: BrainTreeNode;\n\n  constructor(node: BrainTreeNode) {\n    const collapsible = node.children.length > 0\n      ? vscode.TreeItemCollapsibleState.Collapsed\n      : vscode.TreeItemCollapsibleState.None;\n\n    super(node.name, collapsible);\n    this.node = node;\n\n    this.tooltip = `${node.schemaKey}\\n${node.itemCount} memory items`;\n    this.description = node.itemCount > 0 ? `${node.itemCount} items` : '';\n    this.iconPath = nodeIcon(node);\n    this.contextValue = 'contoxContext';\n  }\n}\n\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * Tree data provider for the Contox sidebar panel\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\n\nexport class ContextTreeProvider implements vscode.TreeDataProvider<ContextItem> {\n  private _onDidChangeTreeData = new vscode.EventEmitter<ContextItem | undefined | void>();\n  readonly onDidChangeTreeData = this._onDidChangeTreeData.event;\n\n  private rootNodes: BrainTreeNode[] = [];\n  private total = 0;\n\n  constructor(private readonly _client: ContoxClient) {\n    // _client is available for future features (e.g. inline content preview)\n  }\n\n  setTree(tree: BrainTreeNode[], total: number): void {\n    this.rootNodes = tree;\n    this.total = total;\n    this._onDidChangeTreeData.fire();\n  }\n\n  getTotal(): number {\n    return this.total;\n  }\n\n  getTreeItem(element: ContextItem): vscode.TreeItem {\n    return element;\n  }\n\n  getChildren(element?: ContextItem): ContextItem[] {\n    if (!element) {\n      return this.rootNodes.map((n) => new ContextItem(n));\n    }\n    return element.node.children.map((n) => new ContextItem(n));\n  }\n}\n", "import * as vscode from 'vscode';\r\nimport type { V2PipelineSummary } from '../api/client';\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * Status Bar Manager \u2014 Enhanced with last save time + pipeline status\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\nfunction formatTimeAgo(iso: string): string {\r\n  const diff = Date.now() - new Date(iso).getTime();\r\n  const secs = Math.floor(diff / 1000);\r\n  if (secs < 60) { return 'just now'; }\r\n  const mins = Math.floor(secs / 60);\r\n  if (mins < 60) { return `${mins}m ago`; }\r\n  const hours = Math.floor(mins / 60);\r\n  if (hours < 24) { return `${hours}h ago`; }\r\n  return `${Math.floor(hours / 24)}d ago`;\r\n}\r\n\r\nexport class StatusBarManager implements vscode.Disposable {\r\n  private item: vscode.StatusBarItem;\r\n  private lastSaveIso: string | null = null;\r\n  private refreshTimer: ReturnType<typeof setInterval> | undefined;\r\n\r\n  constructor() {\r\n    this.item = vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Left, 100);\r\n    this.item.command = 'contox.sync';\r\n    this.setIdle();\r\n    this.item.show();\r\n\r\n    // Refresh \"Xm ago\" display every 30s\r\n    this.refreshTimer = setInterval(() => {\r\n      if (this.lastSaveIso) {\r\n        this.setLastSave(this.lastSaveIso);\r\n      }\r\n    }, 30_000);\r\n  }\r\n\r\n  setIdle(): void {\r\n    this.item.text = '$(cloud) Contox';\r\n    this.item.tooltip = 'Click to sync contexts';\r\n    this.item.backgroundColor = undefined;\r\n  }\r\n\r\n  setSyncing(): void {\r\n    this.item.text = '$(sync~spin) Contox: Syncing...';\r\n    this.item.tooltip = 'Syncing contexts...';\r\n    this.item.backgroundColor = undefined;\r\n  }\r\n\r\n  setSynced(): void {\r\n    this.item.text = '$(cloud) Contox: Synced';\r\n    this.item.tooltip = 'Contexts synced \u2014 click to refresh';\r\n    this.item.backgroundColor = undefined;\r\n  }\r\n\r\n  setError(): void {\r\n    this.item.text = '$(error) Contox: Error';\r\n    this.item.tooltip = 'Sync failed \u2014 click to retry';\r\n    this.item.backgroundColor = new vscode.ThemeColor('statusBarItem.errorBackground');\r\n  }\r\n\r\n  /**\r\n   * Show last save time in the status bar.\r\n   */\r\n  setLastSave(iso: string): void {\r\n    this.lastSaveIso = iso;\r\n    const ago = formatTimeAgo(iso);\r\n    this.item.text = `$(cloud) Contox: saved ${ago}`;\r\n    this.item.tooltip = `Last save: ${new Date(iso).toLocaleString()}\\nClick to sync`;\r\n    this.item.backgroundColor = undefined;\r\n  }\r\n\r\n  /**\r\n   * Show active pipeline status.\r\n   */\r\n  setPipeline(pipeline: V2PipelineSummary): void {\r\n    const { completedSteps, totalSteps, status } = pipeline;\r\n\r\n    switch (status) {\r\n      case 'running':\r\n        this.item.text = `$(sync~spin) Contox: pipeline ${completedSteps}/${totalSteps}`;\r\n        this.item.tooltip = `Pipeline running \u2014 ${completedSteps}/${totalSteps} steps complete`;\r\n        this.item.backgroundColor = undefined;\r\n        break;\r\n      case 'done':\r\n        this.item.text = `$(check) Contox: pipeline done`;\r\n        this.item.tooltip = `Pipeline complete \u2014 ${totalSteps} steps`;\r\n        this.item.backgroundColor = undefined;\r\n        break;\r\n      case 'failed':\r\n        this.item.text = `$(error) Contox: pipeline failed`;\r\n        this.item.tooltip = `Pipeline failed \u2014 ${completedSteps}/${totalSteps} steps completed`;\r\n        this.item.backgroundColor = new vscode.ThemeColor('statusBarItem.warningBackground');\r\n        break;\r\n      default:\r\n        this.item.text = `$(clock) Contox: pipeline pending`;\r\n        this.item.tooltip = 'Pipeline pending...';\r\n        this.item.backgroundColor = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show active capture session with live timer and event count.\r\n   * Clicking the status bar triggers a manual flush.\r\n   */\r\n  /**\r\n   * Show disconnected / desynced state.\r\n   */\r\n  setDisconnected(): void {\r\n    this.item.text = '$(debug-disconnect) Contox: Disconnected';\r\n    this.item.tooltip = 'Sync paused \u2014 click to reconnect';\r\n    this.item.command = 'contox.connect';\r\n    this.item.backgroundColor = new vscode.ThemeColor('statusBarItem.warningBackground');\r\n  }\r\n\r\n  setCapturing(durationSecs: number, eventCount: number): void {\r\n    const mins = Math.floor(durationSecs / 60);\r\n    const secs = durationSecs % 60;\r\n    const time = mins > 0 ? `${mins}m ${String(secs).padStart(2, '0')}s` : `${secs}s`;\r\n    this.item.text = `$(record) Contox: ${time} \\u00B7 ${eventCount} events`;\r\n    this.item.tooltip = `Capturing work activity\\n${eventCount} events buffered\\nClick to send now`;\r\n    this.item.command = 'contox.flushCapture';\r\n    this.item.backgroundColor = undefined;\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.refreshTimer) {\r\n      clearInterval(this.refreshTimer);\r\n    }\r\n    this.item.dispose();\r\n  }\r\n}\r\n", "import * as vscode from 'vscode';\nimport { ContoxClient } from '../api/client';\nimport type { V2Session, V2PipelineSummary } from '../api/client';\nimport { StatusBarManager } from './status-bar';\nimport type { GitWatcher } from './git-watcher';\n\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * Session Watcher \u2014 Polls for new saves, shows notifications + pipeline status\n *\n * - Polls GET /api/v2/sessions every 30s\n * - Detects new sessions and shows VS Code notifications\n * - Tracks pipeline progress for active sessions\n * - Updates status bar with last save time\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\n\nconst SESSIONS_POLL_INTERVAL = 30_000; // 30s\nconst PIPELINE_POLL_INTERVAL = 5_000;  // 5s when pipeline active\n\nconst JOB_LABELS: Record<string, string> = {\n  enrich: 'Enrichment',\n  embed: 'Embedding',\n  dedup: 'Deduplication',\n  drift_check: 'Drift Check',\n};\n\nfunction pipelineIcon(status: string): string {\n  switch (status) {\n    case 'done': return '$(check)';\n    case 'failed': return '$(error)';\n    case 'running': return '$(sync~spin)';\n    default: return '$(clock)';\n  }\n}\n\nfunction formatTimeAgo(iso: string): string {\n  const diff = Date.now() - new Date(iso).getTime();\n  const secs = Math.floor(diff / 1000);\n  if (secs < 60) { return 'just now'; }\n  const mins = Math.floor(secs / 60);\n  if (mins < 60) { return `${mins}m ago`; }\n  const hours = Math.floor(mins / 60);\n  if (hours < 24) { return `${hours}h ago`; }\n  return `${Math.floor(hours / 24)}d ago`;\n}\n\nexport class SessionWatcher implements vscode.Disposable {\n  private sessionsTimer: ReturnType<typeof setInterval> | undefined;\n  private pipelineTimer: ReturnType<typeof setInterval> | undefined;\n  private knownSessionIds = new Set<string>();\n  private isFirstPoll = true;\n  private activeSessionId: string | null = null;\n  private trackedActiveSessionId: string | null = null;\n  private lastSaveTime: string | null = null;\n  private projectId: string | null = null;\n  private disposed = false;\n  private gitWatcher: GitWatcher | null = null;\n\n  constructor(\n    private readonly client: ContoxClient,\n    private readonly statusBar: StatusBarManager,\n  ) {}\n\n  /**\n   * Link the GitWatcher so we can reset its buffer when an external\n   * session close is detected (e.g. from the dashboard \"Generate Memory\").\n   */\n  setGitWatcher(watcher: GitWatcher): void {\n    this.gitWatcher = watcher;\n  }\n\n  /**\n   * Start watching a project for new saves.\n   */\n  start(projectId: string): void {\n    this.stop();\n    this.projectId = projectId;\n    this.isFirstPoll = true;\n    this.knownSessionIds.clear();\n\n    // Immediate first poll\n    void this.pollSessions();\n\n    // Start interval\n    this.sessionsTimer = setInterval(() => {\n      void this.pollSessions();\n    }, SESSIONS_POLL_INTERVAL);\n  }\n\n  /**\n   * Stop all polling.\n   */\n  stop(): void {\n    if (this.sessionsTimer) {\n      clearInterval(this.sessionsTimer);\n      this.sessionsTimer = undefined;\n    }\n    this.stopPipelinePolling();\n    this.projectId = null;\n  }\n\n  private stopPipelinePolling(): void {\n    if (this.pipelineTimer) {\n      clearInterval(this.pipelineTimer);\n      this.pipelineTimer = undefined;\n    }\n    this.activeSessionId = null;\n  }\n\n  /* \u2500\u2500 Sessions polling \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\n  private async pollSessions(): Promise<void> {\n    if (this.disposed || !this.projectId) { return; }\n\n    const result = await this.client.listSessions(this.projectId, 5);\n    if (result.error || !result.data) { return; }\n\n    const sessions = result.data.sessions;\n\n    // Update last save time from most recent session\n    if (sessions.length > 0) {\n      const latest = sessions[0]!;\n      this.lastSaveTime = latest.updatedAt;\n      this.statusBar.setLastSave(this.lastSaveTime);\n    }\n\n    // Track the current active session\n    const activeSession = sessions.find((s) => s.status === 'active');\n\n    // On first poll, just record known IDs + active session\n    if (this.isFirstPoll) {\n      for (const s of sessions) {\n        this.knownSessionIds.add(s.id);\n      }\n      this.trackedActiveSessionId = activeSession?.id ?? null;\n      this.isFirstPoll = false;\n      return;\n    }\n\n    // Detect external session close (e.g. dashboard \"Generate Memory\")\n    // If we were tracking an active session and it's now closed, create a new one\n    if (this.trackedActiveSessionId && !activeSession) {\n      console.log('[SessionWatcher] Active session closed externally \u2014 creating new session');\n      this.gitWatcher?.resetBuffer();\n      void this.client.createSession(this.projectId!).then((res) => {\n        if (!res.error && res.data) {\n          this.trackedActiveSessionId = res.data.sessionId;\n          this.knownSessionIds.add(res.data.sessionId);\n          void vscode.window.showInformationMessage(\n            'Contox: Session closed externally \u2014 new session started.',\n          );\n        }\n      });\n    } else {\n      this.trackedActiveSessionId = activeSession?.id ?? null;\n    }\n\n    // Detect new sessions\n    for (const session of sessions) {\n      if (!this.knownSessionIds.has(session.id)) {\n        this.knownSessionIds.add(session.id);\n        this.onNewSession(session);\n      }\n    }\n  }\n\n  /* \u2500\u2500 New session detected \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\n  private onNewSession(session: V2Session): void {\n    // Parse summary if JSON\n    let summaryText = 'New session saved';\n    if (session.summary) {\n      try {\n        const parsed = JSON.parse(session.summary) as Record<string, unknown>;\n        if (typeof parsed['executiveSummary'] === 'string') {\n          summaryText = parsed['executiveSummary'];\n        }\n      } catch {\n        summaryText = session.summary;\n      }\n    }\n\n    // Truncate summary\n    const shortSummary = summaryText.length > 120\n      ? summaryText.slice(0, 117) + '...'\n      : summaryText;\n\n    const source = session.source === 'mcp-server' ? 'MCP'\n      : session.source === 'cli-auto' ? 'CLI'\n      : session.source ?? 'unknown';\n\n    // Show notification with pipeline tracking option\n    void vscode.window.showInformationMessage(\n      `$(cloud-upload) Contox: Session saved (${source}) \u2014 ${shortSummary}`,\n      'View Pipeline',\n      'Dismiss',\n    ).then((action) => {\n      if (action === 'View Pipeline') {\n        this.startPipelinePolling(session.id);\n      }\n    });\n\n    // Update status bar\n    this.lastSaveTime = session.updatedAt;\n    this.statusBar.setLastSave(this.lastSaveTime);\n\n    // Auto-start pipeline polling for new session\n    this.startPipelinePolling(session.id);\n  }\n\n  /* \u2500\u2500 Pipeline polling \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\n  private startPipelinePolling(sessionId: string): void {\n    this.stopPipelinePolling();\n    this.activeSessionId = sessionId;\n\n    // Immediate first poll\n    void this.pollPipeline();\n\n    this.pipelineTimer = setInterval(() => {\n      void this.pollPipeline();\n    }, PIPELINE_POLL_INTERVAL);\n  }\n\n  private async pollPipeline(): Promise<void> {\n    if (this.disposed || !this.activeSessionId) { return; }\n\n    const result = await this.client.getSessionJobs(this.activeSessionId);\n    if (result.error || !result.data) { return; }\n\n    const { jobs, pipeline } = result.data;\n\n    // Update status bar with pipeline info\n    this.statusBar.setPipeline(pipeline);\n\n    // Check if pipeline is terminal\n    if (pipeline.status === 'done' || pipeline.status === 'failed') {\n      this.stopPipelinePolling();\n\n      // Show completion notification\n      const jobDetails = jobs\n        .map((j) => {\n          const icon = j.status === 'done' ? '\u2713' : j.status === 'failed' ? '\u2717' : '\u25CB';\n          const label = JOB_LABELS[j.jobType] ?? j.jobType;\n          return `${icon} ${label}`;\n        })\n        .join('  ');\n\n      if (pipeline.status === 'done') {\n        void vscode.window.showInformationMessage(\n          `$(check) Contox pipeline complete: ${jobDetails}`,\n        );\n      } else {\n        const failedJob = jobs.find((j) => j.status === 'failed');\n        const errorMsg = failedJob?.lastError ? ` \u2014 ${failedJob.lastError.slice(0, 80)}` : '';\n        void vscode.window.showWarningMessage(\n          `$(warning) Contox pipeline failed: ${jobDetails}${errorMsg}`,\n        );\n      }\n\n      // Reset status bar to last save\n      if (this.lastSaveTime) {\n        this.statusBar.setLastSave(this.lastSaveTime);\n      }\n    }\n  }\n\n  dispose(): void {\n    this.disposed = true;\n    this.stop();\n  }\n}\n", "import * as vscode from 'vscode';\r\nimport { execFile } from 'child_process';\r\nimport { promisify } from 'util';\r\n\r\nimport type { ContoxClient, VsCodeCaptureCommit, VsCodeCaptureEvent } from '../api/client';\r\nimport type { StatusBarManager } from './status-bar';\r\n\r\nconst execFileAsync = promisify(execFile);\r\n\r\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\r\n * Git Watcher \u2014 Universal capture sensor for VS Code / Cursor / Windsurf\r\n *\r\n * Watches git commits and file saves, flushes immediately on each commit\r\n * to the Contox V2 ingest API with skipEnrichment=true.\r\n * Enrichment is deferred to user action in the Dashboard Inbox.\r\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\r\n\r\n/** Flush buffer after 15 minutes of inactivity */\r\nconst IDLE_FLUSH_MS = 15 * 60 * 1000;\r\n\r\n/** Auto-flush every 15 minutes regardless of activity */\r\nconst AUTO_FLUSH_INTERVAL_MS = 15 * 60 * 1000;\r\n\r\n/** Volume thresholds */\r\nconst MAX_EVENTS_BEFORE_PROMPT = 50;\r\nconst MAX_PAYLOAD_SIZE_BEFORE_PROMPT = 100 * 1024; // 100KB\r\n\r\n/** Max diff chars per commit for the enrichment pipeline */\r\nconst MAX_DIFF_CHARS_PER_COMMIT = 3000;\r\n\r\n/** Timeout for git diff-tree command (ms) */\r\nconst DIFF_TIMEOUT_MS = 5000;\r\n\r\n/** Files to exclude from diff capture (binary, locks, large generated files) */\r\nconst DIFF_EXCLUDE_PATTERNS = [\r\n  /package-lock\\.json$/,\r\n  /yarn\\.lock$/,\r\n  /pnpm-lock\\.yaml$/,\r\n  /bun\\.lockb$/,\r\n  /\\.lock$/,\r\n  /\\.min\\.(js|css)$/,\r\n  /\\.map$/,\r\n  /\\.wasm$/,\r\n  /\\.png|\\.jpg|\\.jpeg|\\.gif|\\.ico|\\.svg$/,\r\n  /\\.woff2?$/,\r\n  /\\.ttf$/,\r\n  /\\.eot$/,\r\n];\r\n\r\ninterface CaptureBuffer {\r\n  commits: VsCodeCaptureCommit[];\r\n  filesModified: Set<string>;\r\n  activeEditorFiles: Set<string>;\r\n  sessionStartTime: number;\r\n  lastActivityTime: number;\r\n  eventCount: number;\r\n  totalPayloadSize: number;\r\n}\r\n\r\nexport class GitWatcher implements vscode.Disposable {\r\n  private projectId: string | null = null;\r\n  private lastKnownHead: string | null = null;\r\n  private buffer: CaptureBuffer | null = null;\r\n  private disposed = false;\r\n\r\n  // Timers\r\n  private idleTimer: ReturnType<typeof setInterval> | undefined;\r\n  private autoFlushTimer: ReturnType<typeof setInterval> | undefined;\r\n  private captureTickTimer: ReturnType<typeof setInterval> | undefined;\r\n\r\n  // Disposables for VS Code event listeners\r\n  private gitStateDisposable: vscode.Disposable | undefined;\r\n  private fileSaveDisposable: vscode.Disposable | undefined;\r\n\r\n  constructor(\r\n    private readonly client: ContoxClient,\r\n    private readonly statusBar: StatusBarManager,\r\n    private readonly secrets: vscode.SecretStorage,\r\n  ) {}\r\n\r\n  /* \u2500\u2500 Public API \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  start(projectId: string): void {\r\n    if (this.disposed) { return; }\r\n\r\n    const config = vscode.workspace.getConfiguration('contox');\r\n    if (!config.get<boolean>('capture.enabled', true)) { return; }\r\n\r\n    this.projectId = projectId;\r\n    this.initBuffer();\r\n    this.watchGitState();\r\n    this.watchFileSaves();\r\n    this.startTimers();\r\n  }\r\n\r\n  /** Reset the capture buffer (e.g. after an external session close). */\r\n  resetBuffer(): void {\r\n    this.initBuffer();\r\n  }\r\n\r\n  stop(): void {\r\n    this.clearTimers();\r\n    this.gitStateDisposable?.dispose();\r\n    this.gitStateDisposable = undefined;\r\n    this.fileSaveDisposable?.dispose();\r\n    this.fileSaveDisposable = undefined;\r\n    this.projectId = null;\r\n  }\r\n\r\n  async flush(): Promise<void> {\r\n    if (!this.buffer || !this.projectId) { return; }\r\n    if (this.buffer.commits.length === 0 && this.buffer.filesModified.size === 0) { return; }\r\n\r\n    const hmacSecret = await this.getHmacSecret();\r\n    if (!hmacSecret) {\r\n      console.warn('[GitWatcher] No HMAC secret configured \u2014 skipping flush');\r\n      return;\r\n    }\r\n\r\n    const event: VsCodeCaptureEvent = {\r\n      type: 'vscode_capture',\r\n      commits: this.buffer.commits,\r\n      filesModified: [...this.buffer.filesModified],\r\n      sessionDurationMs: Date.now() - this.buffer.sessionStartTime,\r\n      activeEditorFiles: [...this.buffer.activeEditorFiles],\r\n    };\r\n\r\n    const result = await this.client.ingestEvents(this.projectId, event, hmacSecret);\r\n\r\n    if (result.error) {\r\n      console.error('[GitWatcher] Ingest failed:', result.error);\r\n      void vscode.window.showWarningMessage(`Contox: Failed to send captured events \u2014 ${result.error}`);\r\n    } else {\r\n      const commitCount = this.buffer.commits.length;\r\n      const fileCount = this.buffer.filesModified.size;\r\n      console.log(`[GitWatcher] Flushed: ${commitCount} commits, ${fileCount} files`);\r\n    }\r\n\r\n    // Reset buffer\r\n    this.initBuffer();\r\n  }\r\n\r\n  getEventCount(): number {\r\n    return this.buffer?.eventCount ?? 0;\r\n  }\r\n\r\n  getSessionDurationMs(): number {\r\n    if (!this.buffer) { return 0; }\r\n    return Date.now() - this.buffer.sessionStartTime;\r\n  }\r\n\r\n  /**\r\n   * End the current session: flush pending events, close the session via API,\r\n   * and reset the buffer so the next event starts a new session.\r\n   */\r\n  async endSession(): Promise<{ closed: boolean; sessionId?: string; newSessionId?: string }> {\r\n    if (!this.projectId) { return { closed: false }; }\r\n\r\n    // 1. Flush any pending events into the current session\r\n    await this.flush();\r\n\r\n    // 2. Find the active session for this project\r\n    const result = await this.client.getActiveSession(this.projectId);\r\n    if (result.error || !result.data) {\r\n      return { closed: false };\r\n    }\r\n\r\n    // 3. Close it via API\r\n    const closeResult = await this.client.closeSession(result.data.id);\r\n    if (closeResult.error) {\r\n      return { closed: false };\r\n    }\r\n\r\n    // 4. Reset buffer so the next event starts a fresh session\r\n    this.initBuffer();\r\n\r\n    // 5. Create a new session immediately\r\n    let newSessionId: string | undefined;\r\n    const createResult = await this.client.createSession(this.projectId);\r\n    if (!createResult.error && createResult.data) {\r\n      newSessionId = createResult.data.sessionId;\r\n    }\r\n\r\n    return { closed: true, sessionId: result.data.id, newSessionId };\r\n  }\r\n\r\n  /* \u2500\u2500 Git extension integration \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  private watchGitState(): void {\r\n    this.gitStateDisposable?.dispose();\r\n\r\n    // Always start polling as a safety net \u2014 the git extension's onDidChange\r\n    // event doesn't always fire for external CLI commits (especially on Windows)\r\n    this.startGitPolling();\r\n\r\n    try {\r\n      const gitExtension = vscode.extensions.getExtension('vscode.git');\r\n      if (!gitExtension) {\r\n        console.warn('[GitWatcher] Git extension not found \u2014 using polling only');\r\n        return;\r\n      }\r\n\r\n      const git = gitExtension.isActive\r\n        ? gitExtension.exports.getAPI(1)\r\n        : null;\r\n\r\n      if (!git || !git.repositories || git.repositories.length === 0) {\r\n        console.warn('[GitWatcher] No git repositories found \u2014 using polling only');\r\n        return;\r\n      }\r\n\r\n      const repo = git.repositories[0];\r\n      this.lastKnownHead = repo.state?.HEAD?.commit ?? null;\r\n\r\n      // Watch for state changes (new commits, branch switches, etc.)\r\n      // This provides instant detection when it works; polling is the safety net\r\n      this.gitStateDisposable = repo.state.onDidChange(() => {\r\n        void this.onGitStateChanged(repo);\r\n      });\r\n\r\n      console.log('[GitWatcher] Git extension connected + polling safety net active');\r\n    } catch {\r\n      console.warn('[GitWatcher] Failed to access git extension \u2014 using polling only');\r\n    }\r\n  }\r\n\r\n  private async onGitStateChanged(repo: { state: { HEAD?: { commit?: string } } }): Promise<void> {\r\n    if (this.disposed || !this.buffer) { return; }\r\n\r\n    const currentHead = repo.state?.HEAD?.commit ?? null;\r\n    if (!currentHead || currentHead === this.lastKnownHead) { return; }\r\n\r\n    const previousHead = this.lastKnownHead;\r\n    this.lastKnownHead = currentHead;\r\n\r\n    // New commit detected \u2014 extract details\r\n    if (previousHead) {\r\n      await this.captureNewCommits(previousHead, currentHead);\r\n    } else {\r\n      await this.captureCommit(currentHead);\r\n    }\r\n\r\n    // Flush immediately after commit \u2014 ensures events are sent before VS Code closes\r\n    console.log('[GitWatcher] Commit detected \u2014 auto-flushing');\r\n    await this.flush();\r\n\r\n    // Check if this was a push (remote tracking branch updated)\r\n    void this.checkForPush();\r\n  }\r\n\r\n  /**\r\n   * Detect git push by checking if local HEAD matches the remote tracking branch.\r\n   * After a push, the remote ref matches the local ref \u2014 auto-flush as a natural checkpoint.\r\n   */\r\n  private async checkForPush(): Promise<void> {\r\n    const rootPath = this.getWorkspaceRoot();\r\n    if (!rootPath || !this.buffer || this.buffer.eventCount === 0) { return; }\r\n\r\n    try {\r\n      const { stdout: localRef } = await execFileAsync('git', ['rev-parse', 'HEAD'], { cwd: rootPath });\r\n      const { stdout: remoteRef } = await execFileAsync('git', ['rev-parse', '@{u}'], { cwd: rootPath });\r\n\r\n      if (localRef.trim() === remoteRef.trim()) {\r\n        // Local matches remote \u2014 a push just happened\r\n        console.log('[GitWatcher] Push detected \u2014 auto-flushing');\r\n        await this.flush();\r\n      }\r\n    } catch {\r\n      // No upstream configured or git error \u2014 ignore\r\n    }\r\n  }\r\n\r\n  private gitPollTimer: ReturnType<typeof setInterval> | undefined;\r\n\r\n  private startGitPolling(): void {\r\n    if (this.gitPollTimer) { return; } // Already polling\r\n    // Poll git HEAD every 5 seconds for reliable commit detection\r\n    console.log('[GitWatcher] Starting git HEAD polling (5s interval)');\r\n    void this.pollGitHead(); // Immediate first poll\r\n    this.gitPollTimer = setInterval(() => {\r\n      void this.pollGitHead();\r\n    }, 5_000);\r\n  }\r\n\r\n  private async pollGitHead(): Promise<void> {\r\n    if (this.disposed || !this.buffer) { return; }\r\n\r\n    const rootPath = this.getWorkspaceRoot();\r\n    if (!rootPath) {\r\n      console.warn('[GitWatcher] pollGitHead: no workspace root');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { stdout } = await execFileAsync('git', ['rev-parse', 'HEAD'], { cwd: rootPath });\r\n      const currentHead = stdout.trim();\r\n\r\n      if (!this.lastKnownHead) {\r\n        console.log(`[GitWatcher] pollGitHead: initial HEAD = ${currentHead.slice(0, 8)}`);\r\n      }\r\n\r\n      if (this.lastKnownHead && currentHead !== this.lastKnownHead) {\r\n        console.log(`[GitWatcher] Commit detected (poll): ${this.lastKnownHead.slice(0, 8)} \u2192 ${currentHead.slice(0, 8)}`);\r\n        await this.captureNewCommits(this.lastKnownHead, currentHead);\r\n        console.log('[GitWatcher] Commit captured \u2014 auto-flushing');\r\n        await this.flush();\r\n      }\r\n\r\n      this.lastKnownHead = currentHead;\r\n    } catch {\r\n      // Git not available or not a repo \u2014 ignore\r\n    }\r\n  }\r\n\r\n  /* \u2500\u2500 Commit capture \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  private async captureNewCommits(fromSha: string, toSha: string): Promise<void> {\r\n    const rootPath = this.getWorkspaceRoot();\r\n    if (!rootPath || !this.buffer) { return; }\r\n\r\n    try {\r\n      // Get commit log between fromSha and toSha\r\n      const { stdout } = await execFileAsync('git', [\r\n        'log', `${fromSha}..${toSha}`,\r\n        '--format=%H|%s|%an|%aI',\r\n        '--no-merges',\r\n      ], { cwd: rootPath });\r\n\r\n      const lines = stdout.trim().split('\\n').filter(Boolean);\r\n      for (const line of lines) {\r\n        const [sha, message, author, timestamp] = line.split('|');\r\n        if (!sha) { continue; }\r\n        await this.captureCommitDetails(rootPath, sha, message ?? '', author ?? '', timestamp ?? '');\r\n      }\r\n    } catch {\r\n      // Fallback: just capture the tip commit\r\n      await this.captureCommit(toSha);\r\n    }\r\n  }\r\n\r\n  private async captureCommit(sha: string): Promise<void> {\r\n    const rootPath = this.getWorkspaceRoot();\r\n    if (!rootPath || !this.buffer) { return; }\r\n\r\n    try {\r\n      const { stdout } = await execFileAsync('git', [\r\n        'log', '-1', sha, '--format=%s|%an|%aI',\r\n      ], { cwd: rootPath });\r\n\r\n      const [message, author, timestamp] = stdout.trim().split('|');\r\n      await this.captureCommitDetails(rootPath, sha, message ?? '', author ?? '', timestamp ?? '');\r\n    } catch {\r\n      // Can't get commit info \u2014 skip\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Capture compact diff context for a commit.\r\n   * Runs `git diff-tree -p -U2` with a hard timeout, strips excluded files,\r\n   * and truncates to MAX_DIFF_CHARS_PER_COMMIT.\r\n   */\r\n  private async captureDiffContext(rootPath: string, sha: string): Promise<string | undefined> {\r\n    const config = vscode.workspace.getConfiguration('contox');\r\n    const includeDiffs = config.get<boolean>('capture.includeDiffs', true);\r\n    if (!includeDiffs) {\r\n      return undefined;\r\n    }\r\n\r\n    try {\r\n      const { stdout } = await execFileAsync('git', [\r\n        'diff-tree', '-p', '-U4', '--no-commit-id', sha,\r\n      ], { cwd: rootPath, timeout: DIFF_TIMEOUT_MS, maxBuffer: 512 * 1024 });\r\n\r\n      if (!stdout || stdout.trim().length === 0) {\r\n        return undefined;\r\n      }\r\n\r\n      // Filter out excluded file diffs and strip binary diffs\r\n      const filtered = this.filterExcludedDiffs(stdout);\r\n      if (!filtered || filtered.length === 0) {\r\n        return undefined;\r\n      }\r\n\r\n      // Truncate to limit\r\n      return filtered.length > MAX_DIFF_CHARS_PER_COMMIT\r\n        ? filtered.slice(0, MAX_DIFF_CHARS_PER_COMMIT)\r\n        : filtered;\r\n    } catch {\r\n      // Timeout or error \u2014 not critical, skip diff\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Filter excluded files from a unified diff output.\r\n   * Removes diffs for lock files, binaries, and large generated files.\r\n   */\r\n  private filterExcludedDiffs(rawDiff: string): string {\r\n    const sections = rawDiff.split(/^(?=diff --git )/m);\r\n    const kept: string[] = [];\r\n\r\n    for (const section of sections) {\r\n      if (!section.trim()) { continue; }\r\n\r\n      // Extract file path from \"diff --git a/path b/path\"\r\n      const headerMatch = section.match(/^diff --git a\\/(.+?) b\\//);\r\n      const filePath = headerMatch?.[1] ?? '';\r\n\r\n      // Skip if matches exclude patterns\r\n      if (DIFF_EXCLUDE_PATTERNS.some((pat) => pat.test(filePath))) {\r\n        continue;\r\n      }\r\n\r\n      // Skip binary diffs\r\n      if (section.includes('Binary files')) {\r\n        continue;\r\n      }\r\n\r\n      kept.push(section);\r\n    }\r\n\r\n    return kept.join('');\r\n  }\r\n\r\n  private async captureCommitDetails(\r\n    rootPath: string, sha: string, message: string, author: string, timestamp: string,\r\n  ): Promise<void> {\r\n    if (!this.buffer) { return; }\r\n\r\n    let filesChanged: string[] = [];\r\n    let insertions = 0;\r\n    let deletions = 0;\r\n\r\n    try {\r\n      const { stdout } = await execFileAsync('git', [\r\n        'diff-tree', '--no-commit-id', '-r', '--numstat', sha,\r\n      ], { cwd: rootPath });\r\n\r\n      for (const line of stdout.trim().split('\\n').filter(Boolean)) {\r\n        const parts = line.split('\\t');\r\n        const ins = parseInt(parts[0] ?? '0', 10);\r\n        const del = parseInt(parts[1] ?? '0', 10);\r\n        const file = parts[2] ?? '';\r\n\r\n        if (file && !this.isExcluded(file)) {\r\n          filesChanged.push(file);\r\n          insertions += isNaN(ins) ? 0 : ins;\r\n          deletions += isNaN(del) ? 0 : del;\r\n          this.buffer.filesModified.add(file);\r\n        }\r\n      }\r\n    } catch {\r\n      // Can't get diff stats \u2014 proceed without\r\n    }\r\n\r\n    // Apply exclude patterns to file list\r\n    filesChanged = filesChanged.filter((f) => !this.isExcluded(f));\r\n\r\n    // Capture compact diff context (runs in parallel concept \u2014 but sequential here for simplicity)\r\n    const diff = await this.captureDiffContext(rootPath, sha);\r\n\r\n    const commit: VsCodeCaptureCommit = {\r\n      sha: sha.slice(0, 12),\r\n      message: message.slice(0, 500),\r\n      author: author.slice(0, 200),\r\n      timestamp,\r\n      filesChanged,\r\n      insertions,\r\n      deletions,\r\n      ...(diff ? { diff } : {}),\r\n    };\r\n\r\n    this.buffer.commits.push(commit);\r\n    this.buffer.eventCount += 1;\r\n    this.buffer.totalPayloadSize += JSON.stringify(commit).length;\r\n    this.buffer.lastActivityTime = Date.now();\r\n\r\n    // Update status bar\r\n    this.updateStatusBar();\r\n\r\n    // Check volume thresholds\r\n    this.checkVolumeThreshold();\r\n  }\r\n\r\n  /* \u2500\u2500 File save tracking \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  private watchFileSaves(): void {\r\n    this.fileSaveDisposable?.dispose();\r\n\r\n    this.fileSaveDisposable = vscode.workspace.onDidSaveTextDocument((doc) => {\r\n      if (!this.buffer || this.disposed) { return; }\r\n\r\n      const relativePath = vscode.workspace.asRelativePath(doc.uri, false);\r\n      if (!this.isExcluded(relativePath)) {\r\n        const isNew = !this.buffer.filesModified.has(relativePath);\r\n        this.buffer.filesModified.add(relativePath);\r\n        this.buffer.lastActivityTime = Date.now();\r\n        if (isNew) {\r\n          this.buffer.eventCount += 1;\r\n        }\r\n      }\r\n    });\r\n\r\n    // Track active editor files\r\n    vscode.window.onDidChangeActiveTextEditor((editor) => {\r\n      if (!this.buffer || this.disposed || !editor) { return; }\r\n      const relativePath = vscode.workspace.asRelativePath(editor.document.uri, false);\r\n      if (!this.isExcluded(relativePath)) {\r\n        this.buffer.activeEditorFiles.add(relativePath);\r\n      }\r\n    });\r\n  }\r\n\r\n  /* \u2500\u2500 Timers & notifications \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  private startTimers(): void {\r\n    this.clearTimers();\r\n\r\n    // Idle flush timer \u2014 check every 60s\r\n    this.idleTimer = setInterval(() => {\r\n      if (!this.buffer || this.buffer.eventCount === 0) { return; }\r\n      const idle = Date.now() - this.buffer.lastActivityTime;\r\n      if (idle > IDLE_FLUSH_MS) {\r\n        void this.flush();\r\n      }\r\n    }, 60_000);\r\n\r\n    // Auto-flush timer \u2014 flush every 15 minutes regardless of activity\r\n    this.autoFlushTimer = setInterval(() => {\r\n      if (!this.buffer || this.buffer.eventCount === 0) { return; }\r\n      console.log(`[GitWatcher] Auto-flush: ${this.buffer.eventCount} events, ${this.buffer.commits.length} commits`);\r\n      void this.flush();\r\n    }, AUTO_FLUSH_INTERVAL_MS);\r\n\r\n    // Status bar tick \u2014 every 1 second for live timer\r\n    this.captureTickTimer = setInterval(() => {\r\n      this.updateStatusBar();\r\n    }, 1_000);\r\n  }\r\n\r\n  private clearTimers(): void {\r\n    if (this.idleTimer) { clearInterval(this.idleTimer); this.idleTimer = undefined; }\r\n    if (this.autoFlushTimer) { clearInterval(this.autoFlushTimer); this.autoFlushTimer = undefined; }\r\n    if (this.captureTickTimer) { clearInterval(this.captureTickTimer); this.captureTickTimer = undefined; }\r\n    if (this.gitPollTimer) { clearInterval(this.gitPollTimer); this.gitPollTimer = undefined; }\r\n  }\r\n\r\n  private checkVolumeThreshold(): void {\r\n    if (!this.buffer) { return; }\r\n\r\n    if (\r\n      this.buffer.eventCount >= MAX_EVENTS_BEFORE_PROMPT ||\r\n      this.buffer.totalPayloadSize >= MAX_PAYLOAD_SIZE_BEFORE_PROMPT\r\n    ) {\r\n      console.log(`[GitWatcher] Volume threshold reached (${this.buffer.eventCount} events) \u2014 auto-flushing`);\r\n      void this.flush();\r\n    }\r\n  }\r\n\r\n  /* \u2500\u2500 Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  private initBuffer(): void {\r\n    this.buffer = {\r\n      commits: [],\r\n      filesModified: new Set(),\r\n      activeEditorFiles: new Set(),\r\n      sessionStartTime: Date.now(),\r\n      lastActivityTime: Date.now(),\r\n      eventCount: 0,\r\n      totalPayloadSize: 0,\r\n    };\r\n  }\r\n\r\n  private updateStatusBar(): void {\r\n    if (!this.buffer || this.buffer.eventCount === 0) { return; }\r\n\r\n    const durationSecs = Math.floor(this.getSessionDurationMs() / 1000);\r\n    this.statusBar.setCapturing(durationSecs, this.buffer.eventCount);\r\n  }\r\n\r\n  private getWorkspaceRoot(): string | null {\r\n    const folders = vscode.workspace.workspaceFolders;\r\n    if (!folders || folders.length === 0) { return null; }\r\n    return folders[0]!.uri.fsPath;\r\n  }\r\n\r\n  private isExcluded(filePath: string): boolean {\r\n    const config = vscode.workspace.getConfiguration('contox');\r\n    const patterns = config.get<string[]>('capture.excludePatterns', [\r\n      '*.env', '*.key', '*.pem', '*.p12', '*.pfx',\r\n      'node_modules/**', '.git/**', 'dist/**',\r\n    ]);\r\n\r\n    const lower = filePath.toLowerCase();\r\n    for (const pattern of patterns) {\r\n      // Simple glob matching: *.ext and dir/**\r\n      if (pattern.startsWith('*')) {\r\n        if (lower.endsWith(pattern.slice(1))) { return true; }\r\n      } else if (pattern.endsWith('/**')) {\r\n        const dir = pattern.slice(0, -3);\r\n        if (lower.startsWith(dir + '/') || lower.startsWith(dir + '\\\\')) { return true; }\r\n      } else if (lower === pattern.toLowerCase()) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private hmacSecretWarningShown = false;\r\n\r\n  private async getHmacSecret(): Promise<string | null> {\r\n    // 1. Try VS Code SecretStorage first\r\n    const fromSecrets = await this.secrets.get('contox-hmac-secret');\r\n    if (fromSecrets) { return fromSecrets; }\r\n\r\n    // 2. Try settings fallback\r\n    const config = vscode.workspace.getConfiguration('contox');\r\n    const fromSettings = config.get<string>('hmacSecret', '');\r\n    if (fromSettings) { return fromSettings; }\r\n\r\n    // 3. API fallback \u2014 fetch from server and cache in SecretStorage\r\n    if (this.projectId) {\r\n      try {\r\n        const result = await this.client.getProjectHmacSecret(this.projectId);\r\n        if (result.data?.hmacSecret) {\r\n          await this.secrets.store('contox-hmac-secret', result.data.hmacSecret);\r\n          console.log('[GitWatcher] HMAC secret fetched from API and cached');\r\n          return result.data.hmacSecret;\r\n        }\r\n      } catch {\r\n        // API call failed \u2014 continue to warning\r\n      }\r\n    }\r\n\r\n    // 4. Show user-facing warning (once per session)\r\n    if (!this.hmacSecretWarningShown) {\r\n      this.hmacSecretWarningShown = true;\r\n      void vscode.window.showWarningMessage(\r\n        'Contox: Capture events cannot be sent \u2014 HMAC secret missing. Re-run \"Contox: Setup\" to fix.',\r\n        'Open Setup',\r\n      ).then((action) => {\r\n        if (action === 'Open Setup') {\r\n          void vscode.commands.executeCommand('contox.setup');\r\n        }\r\n      });\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /* \u2500\u2500 Cleanup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\r\n\r\n  dispose(): void {\r\n    this.disposed = true;\r\n    // Flush remaining events on deactivation\r\n    void this.flush();\r\n    this.stop();\r\n  }\r\n}\r\n", "import * as vscode from 'vscode';\nimport { ContoxClient } from '../api/client';\n\n/**\n * \"Contox: Login\"\n *\n * Prompts for an API key, stores it in VS Code's secret storage, and\n * validates it by making a lightweight API call.\n */\nexport function registerLoginCommand(client: ContoxClient): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.login', async () => {\n    const key = await vscode.window.showInputBox({\n      prompt: 'Enter your Contox API key',\n      password: true,\n      placeHolder: 'ctx_xxxxxxxxxxxxxxxx',\n      ignoreFocusOut: true,\n    });\n\n    if (!key) {\n      return;\n    }\n\n    await client.setApiKey(key);\n\n    // Validate the key by fetching the user profile\n    // We use getContext with a dummy id \u2014 a 401 means the key is bad.\n    // Instead, try a lightweight call that requires auth.\n    // The simplest check: call GET /api/contexts (returns [] when no projectId given\n    // but still validates auth). However the /api/contexts GET requires userId auth.\n    // Let's call getContext with a non-existent id \u2014 if we get 401 the key is invalid,\n    // any other response (404, 500) means the key is valid.\n    const validation = await client.getContext('__ping__');\n    if (validation.error === 'Unauthorized' || validation.error === 'Not authenticated. Run \"Contox: Login\" first.') {\n      await client.clearApiKey();\n      void vscode.window.showErrorMessage('Contox: Invalid API key.');\n      return;\n    }\n\n    void vscode.window.showInformationMessage('Contox: Logged in successfully');\n\n    // If a project is already configured, kick off a sync\n    await vscode.commands.executeCommand('contox.sync');\n  });\n}\n", "import * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nimport { ContoxClient, ContoxProject } from '../api/client';\n\n/**\n * \"Contox: Initialize Project\"\n *\n * Walks the user through selecting a project (from the API) and writes\n * a .contox.json config file in the workspace root so other commands\n * know which teamId / projectId to use.\n */\nexport function registerInitCommand(client: ContoxClient): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.init', async () => {\n    // Must be authenticated\n    const key = await client.getApiKey();\n    if (!key) {\n      void vscode.window.showWarningMessage('Contox: Not logged in. Run \"Contox: Login\" first.');\n      return;\n    }\n\n    // Must have a workspace folder open\n    const workspaceFolders = vscode.workspace.workspaceFolders;\n    if (!workspaceFolders || workspaceFolders.length === 0) {\n      void vscode.window.showErrorMessage('Contox: Open a workspace folder first.');\n      return;\n    }\n\n    const rootPath = workspaceFolders[0]!.uri.fsPath;\n    const configPath = path.join(rootPath, '.contox.json');\n\n    // If already initialized, ask whether to reconfigure\n    if (fs.existsSync(configPath)) {\n      const overwrite = await vscode.window.showWarningMessage(\n        'Contox: This workspace is already initialized. Reconfigure?',\n        'Yes',\n        'No',\n      );\n      if (overwrite !== 'Yes') {\n        return;\n      }\n    }\n\n    // Ask for teamId \u2014 the user's organization ID\n    const teamId = await vscode.window.showInputBox({\n      prompt: 'Enter your Contox organization (team) ID',\n      placeHolder: 'e.g. 6632a1\u2026',\n      ignoreFocusOut: true,\n    });\n\n    if (!teamId) {\n      return;\n    }\n\n    // Fetch projects for that team\n    const projectsResult = await client.listProjects(teamId);\n    if (projectsResult.error) {\n      void vscode.window.showErrorMessage(`Contox: ${projectsResult.error}`);\n      return;\n    }\n\n    const projects = projectsResult.data ?? [];\n\n    // Let the user pick an existing project or create a new one\n    interface ProjectQuickPickItem extends vscode.QuickPickItem {\n      project?: ContoxProject;\n    }\n\n    const items: ProjectQuickPickItem[] = [\n      ...projects.map((p) => ({\n        label: p.name,\n        description: `${p.contextsCount} context${p.contextsCount === 1 ? '' : 's'}`,\n        project: p,\n      })),\n      { label: '$(add) Create a new project...', description: '' },\n    ];\n\n    const picked = await vscode.window.showQuickPick(items, {\n      placeHolder: 'Select a project to link to this workspace',\n      ignoreFocusOut: true,\n    });\n\n    if (!picked) {\n      return;\n    }\n\n    let selectedProject: ContoxProject | undefined = picked.project;\n\n    // Handle \"create new project\" flow \u2014 the user creates it on the web\n    if (!selectedProject) {\n      void vscode.window.showInformationMessage(\n        'Create a new project on the Contox dashboard, then run \"Contox: Initialize Project\" again.',\n      );\n      return;\n    }\n\n    // Write .contox.json\n    const config = {\n      teamId,\n      projectId: selectedProject.id,\n      projectName: selectedProject.name,\n    };\n\n    fs.writeFileSync(configPath, JSON.stringify(config, null, 2) + '\\n');\n    void vscode.window.showInformationMessage(\n      `Contox: Linked workspace to project \"${selectedProject.name}\"`,\n    );\n\n    // Trigger a sync so the sidebar populates immediately\n    await vscode.commands.executeCommand('contox.sync');\n  });\n}\n", "import * as vscode from 'vscode';\nimport { ContoxClient } from '../api/client';\nimport { ContextTreeProvider } from '../providers/context-tree';\nimport { StatusBarManager } from '../providers/status-bar';\nimport { getWorkspaceConfig } from '../extension';\n\n/**\n * \"Contox: Sync Contexts\"\n *\n * Fetches the V2 brain for the currently linked project (from .contox.json)\n * and refreshes the sidebar tree view.\n */\nexport function registerSyncCommand(\n  client: ContoxClient,\n  treeProvider: ContextTreeProvider,\n  statusBar: StatusBarManager,\n): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.sync', async () => {\n    const key = await client.getApiKey();\n    if (!key) {\n      void vscode.window.showWarningMessage('Contox: Not logged in. Run \"Contox: Login\" first.');\n      return;\n    }\n\n    const config = getWorkspaceConfig();\n    if (!config) {\n      void vscode.window.showWarningMessage(\n        'Contox: No project linked. Run \"Contox: Initialize Project\" first.',\n      );\n      return;\n    }\n\n    statusBar.setSyncing();\n\n    const result = await client.getBrain(config.projectId);\n    if (result.error) {\n      statusBar.setError();\n      void vscode.window.showErrorMessage(`Contox sync failed: ${result.error}`);\n      return;\n    }\n\n    const tree = result.data?.tree ?? [];\n    const itemsLoaded = result.data?.itemsLoaded ?? 0;\n    treeProvider.setTree(tree, itemsLoaded);\n    statusBar.setSynced();\n    void vscode.window.showInformationMessage(\n      `Contox: Loaded ${itemsLoaded} memory items from \"${config.projectName}\"`,\n    );\n  });\n}\n", "import * as vscode from 'vscode';\nimport { ContoxClient } from '../api/client';\nimport { ContextTreeProvider } from '../providers/context-tree';\nimport { StatusBarManager } from '../providers/status-bar';\nimport { getWorkspaceConfig } from '../extension';\n\n/**\n * \"Contox: Create Context\"\n *\n * Creates a new context inside the currently linked project.\n * Requires .contox.json with teamId and projectId.\n */\nexport function registerCreateCommand(\n  client: ContoxClient,\n  treeProvider: ContextTreeProvider,\n  statusBar: StatusBarManager,\n): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.create', async () => {\n    const key = await client.getApiKey();\n    if (!key) {\n      void vscode.window.showWarningMessage('Contox: Not logged in. Run \"Contox: Login\" first.');\n      return;\n    }\n\n    const config = getWorkspaceConfig();\n    if (!config) {\n      void vscode.window.showWarningMessage(\n        'Contox: No project linked. Run \"Contox: Initialize Project\" first.',\n      );\n      return;\n    }\n\n    const name = await vscode.window.showInputBox({\n      prompt: 'Context name',\n      placeHolder: 'e.g. API Documentation',\n      ignoreFocusOut: true,\n    });\n\n    if (!name) {\n      return;\n    }\n\n    const description = await vscode.window.showInputBox({\n      prompt: 'Description (optional)',\n      placeHolder: 'e.g. REST API docs for the backend',\n      ignoreFocusOut: true,\n    });\n\n    const result = await client.createContext(\n      name,\n      config.teamId,\n      config.projectId,\n      description || undefined,\n    );\n\n    if (result.error) {\n      void vscode.window.showErrorMessage(`Contox: Failed to create context \u2014 ${result.error}`);\n      return;\n    }\n\n    void vscode.window.showInformationMessage(`Contox: Created context \"${name}\"`);\n\n    // Refresh the brain tree\n    statusBar.setSyncing();\n    const brainResult = await client.getBrain(config.projectId);\n    if (!brainResult.error && brainResult.data) {\n      treeProvider.setTree(brainResult.data.tree, brainResult.data.itemsLoaded);\n    }\n    statusBar.setSynced();\n  });\n}\n", "import * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as os from 'os';\nimport { ContoxClient, ContoxProject, ContoxTeam } from '../api/client';\nimport { ContextTreeProvider } from '../providers/context-tree';\nimport { StatusBarManager } from '../providers/status-bar';\nimport { getMcpServerPath } from '../lib/mcp-deployer';\n\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * Setup Wizard \u2014 Guided onboarding webview panel\n *\n * Step-by-step GUI that walks the user through:\n * 1. Welcome + API key login\n * 2. Select or create a team/org\n * 3. Select or create a project\n * 4. Choose AI tools (Claude, Cursor, Copilot, etc.) \u2192 auto-configure\n * 5. First scan \u2192 done\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\n\nlet currentPanel: vscode.WebviewPanel | undefined;\n\nexport function registerSetupWizardCommand(\n  client: ContoxClient,\n  treeProvider: ContextTreeProvider,\n  statusBar: StatusBarManager,\n  context: vscode.ExtensionContext,\n): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.setup', () => {\n    openSetupWizard(client, treeProvider, statusBar, context);\n  });\n}\n\nexport function openSetupWizard(\n  client: ContoxClient,\n  treeProvider: ContextTreeProvider,\n  statusBar: StatusBarManager,\n  context: vscode.ExtensionContext,\n): void {\n  if (currentPanel) {\n    currentPanel.reveal(vscode.ViewColumn.One);\n    return;\n  }\n\n  currentPanel = vscode.window.createWebviewPanel(\n    'contoxSetup',\n    'Contox Setup',\n    vscode.ViewColumn.One,\n    {\n      enableScripts: true,\n      retainContextWhenHidden: true,\n    },\n  );\n\n  currentPanel.webview.html = getWebviewContent();\n\n  // Handle messages from the webview\n  currentPanel.webview.onDidReceiveMessage(\n    async (message: WebviewMessage) => {\n      await handleMessage(message, client, treeProvider, statusBar, currentPanel!, context);\n    },\n    undefined,\n    context.subscriptions,\n  );\n\n  currentPanel.onDidDispose(() => {\n    currentPanel = undefined;\n  });\n\n  // Check if already logged in and send initial state\n  void (async () => {\n    const key = await client.getApiKey();\n    if (key) {\n      currentPanel?.webview.postMessage({ type: 'alreadyLoggedIn' });\n    }\n  })();\n}\n\n/* \u2500\u2500 Message types \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\ninterface WebviewMessage {\n  type: string;\n  apiKey?: string;\n  teamId?: string;\n  projectName?: string;\n  projectId?: string;\n  aiTools?: string[];\n}\n\n/* \u2500\u2500 Message handler \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\nasync function handleMessage(\n  message: WebviewMessage,\n  client: ContoxClient,\n  treeProvider: ContextTreeProvider,\n  statusBar: StatusBarManager,\n  panel: vscode.WebviewPanel,\n  extensionContext: vscode.ExtensionContext,\n): Promise<void> {\n  const post = (msg: Record<string, unknown>): void => {\n    void panel.webview.postMessage(msg);\n  };\n\n  switch (message.type) {\n    case 'login': {\n      if (!message.apiKey) {\n        post({ type: 'loginResult', success: false, error: 'No API key provided' });\n        return;\n      }\n      await client.setApiKey(message.apiKey);\n\n      // Validate key\n      const validation = await client.getContext('__ping__');\n      if (validation.error === 'Unauthorized') {\n        await client.clearApiKey();\n        post({ type: 'loginResult', success: false, error: 'Invalid API key' });\n        return;\n      }\n\n      post({ type: 'loginResult', success: true });\n      break;\n    }\n\n    case 'loadTeams': {\n      const teamsResult = await client.listTeams();\n      if (teamsResult.error) {\n        post({ type: 'teamsLoaded', success: false, error: teamsResult.error });\n        return;\n      }\n      post({\n        type: 'teamsLoaded',\n        success: true,\n        teams: (teamsResult.data ?? []).map((t: ContoxTeam) => ({\n          id: t.id,\n          name: t.name,\n          members: t.members,\n        })),\n      });\n      break;\n    }\n\n    case 'loadProjects': {\n      if (!message.teamId) {\n        post({ type: 'projectsLoaded', success: false, error: 'No team ID provided' });\n        return;\n      }\n      const result = await client.listProjects(message.teamId);\n      if (result.error) {\n        post({ type: 'projectsLoaded', success: false, error: result.error });\n        return;\n      }\n      post({\n        type: 'projectsLoaded',\n        success: true,\n        projects: (result.data ?? []).map((p: ContoxProject) => ({\n          id: p.id,\n          name: p.name,\n          contextsCount: p.contextsCount,\n        })),\n      });\n      break;\n    }\n\n    case 'selectProject': {\n      if (!message.teamId || !message.projectId || !message.projectName) { return; }\n\n      const workspaceFolders = vscode.workspace.workspaceFolders;\n      if (!workspaceFolders || workspaceFolders.length === 0) {\n        post({ type: 'projectSelected', success: false, error: 'No workspace folder open' });\n        return;\n      }\n\n      const rootPath = workspaceFolders[0]!.uri.fsPath;\n      const configPath = path.join(rootPath, '.contox.json');\n      const config = {\n        teamId: message.teamId,\n        projectId: message.projectId,\n        projectName: message.projectName,\n      };\n\n      try {\n        fs.writeFileSync(configPath, JSON.stringify(config, null, 2) + '\\n');\n\n        // Fetch and store the per-project HMAC secret for auto-capture signing\n        const hmacResult = await client.getProjectHmacSecret(message.projectId);\n        if (hmacResult.data?.hmacSecret) {\n          await extensionContext.secrets.store('contox-hmac-secret', hmacResult.data.hmacSecret);\n        }\n\n        post({ type: 'projectSelected', success: true });\n\n        // Sync the sidebar with V2 brain\n        statusBar.setSyncing();\n        const brainResult = await client.getBrain(message.projectId);\n        if (!brainResult.error && brainResult.data) {\n          treeProvider.setTree(brainResult.data.tree, brainResult.data.itemsLoaded);\n        }\n        statusBar.setSynced();\n      } catch (err) {\n        post({ type: 'projectSelected', success: false, error: String(err) });\n      }\n      break;\n    }\n\n    case 'configureAI': {\n      const tools = message.aiTools ?? [];\n      const results: string[] = [];\n\n      const workspaceFolders = vscode.workspace.workspaceFolders;\n      const rootPath = workspaceFolders?.[0]?.uri.fsPath ?? '';\n\n      // Read existing .contox.json for teamId/projectId\n      let teamId = '';\n      let projectId = '';\n      try {\n        const raw = fs.readFileSync(path.join(rootPath, '.contox.json'), 'utf-8');\n        const cfg = JSON.parse(raw) as Record<string, string>;\n        teamId = cfg['teamId'] ?? '';\n        projectId = cfg['projectId'] ?? '';\n      } catch {\n        // continue\n      }\n\n      const apiKey = await client.getApiKey() ?? '';\n      const apiUrl = vscode.workspace.getConfiguration('contox').get<string>('apiUrl', 'https://contox.dev');\n      const hmacSecret = await extensionContext.secrets.get('contox-hmac-secret') ?? '';\n\n      // Configure Claude (MCP server)\n      if (tools.includes('claude')) {\n        try {\n          configureClaude(apiKey, apiUrl, teamId, projectId, rootPath, hmacSecret, extensionContext);\n          results.push('Claude MCP server configured');\n        } catch (err) {\n          results.push(`Claude: ${String(err)}`);\n        }\n      }\n\n      // Configure Cursor (MCP server)\n      if (tools.includes('cursor')) {\n        try {\n          configureCursor(apiKey, apiUrl, teamId, projectId, rootPath, hmacSecret, extensionContext);\n          results.push('Cursor MCP server configured');\n        } catch (err) {\n          results.push(`Cursor: ${String(err)}`);\n        }\n      }\n\n      // Configure Copilot (MCP server via .vscode/mcp.json)\n      if (tools.includes('copilot')) {\n        try {\n          configureCopilot(apiKey, apiUrl, teamId, projectId, rootPath, hmacSecret, extensionContext);\n          results.push('Copilot MCP server configured');\n        } catch (err) {\n          results.push(`Copilot: ${String(err)}`);\n        }\n      }\n\n      // Configure Windsurf (MCP server via global config)\n      if (tools.includes('windsurf')) {\n        try {\n          configureWindsurf(apiKey, apiUrl, teamId, extensionContext);\n          results.push('Windsurf MCP server configured');\n        } catch (err) {\n          results.push(`Windsurf: ${String(err)}`);\n        }\n      }\n\n      // Configure Antigravity (MCP server via ~/.gemini/antigravity/mcp_config.json)\n      if (tools.includes('antigravity')) {\n        try {\n          configureAntigravity(apiKey, apiUrl, teamId, projectId, extensionContext);\n          results.push('Antigravity MCP server configured');\n        } catch (err) {\n          results.push(`Antigravity: ${String(err)}`);\n        }\n      }\n\n      post({ type: 'aiConfigured', results });\n      break;\n    }\n\n    case 'runScan': {\n      // Run contox scan with API key passed via environment\n      post({ type: 'scanStarted' });\n\n      try {\n        const workspaceFolders = vscode.workspace.workspaceFolders;\n        if (!workspaceFolders) {\n          post({ type: 'scanResult', success: false, error: 'No workspace open' });\n          return;\n        }\n\n        const scanApiKey = await client.getApiKey() ?? '';\n        const scanApiUrl = vscode.workspace.getConfiguration('contox').get<string>('apiUrl', 'https://contox.dev');\n\n        // Write ~/.contoxrc so the CLI can authenticate\n        const contoxRcPath = path.join(os.homedir(), '.contoxrc');\n        fs.writeFileSync(contoxRcPath, JSON.stringify({ apiKey: scanApiKey, apiUrl: scanApiUrl }, null, 2), 'utf-8');\n\n        const terminal = vscode.window.createTerminal('Contox Scan');\n        terminal.sendText('node packages/cli/dist/index.js scan');\n        terminal.show();\n\n        post({ type: 'scanResult', success: true });\n      } catch (err) {\n        post({ type: 'scanResult', success: false, error: String(err) });\n      }\n      break;\n    }\n\n    case 'finish': {\n      panel.dispose();\n      void vscode.window.showInformationMessage('Contox: Setup complete! Your AI now has persistent memory.');\n      break;\n    }\n  }\n}\n\n/* \u2500\u2500 AI Tool Configuration Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\n/**\n * Configure MCP for all AI tools at once. Called by the deep link handler.\n */\nexport function configureAllMcp(\n  apiKey: string,\n  apiUrl: string,\n  teamId: string,\n  projectId: string,\n  rootPath: string,\n  hmacSecret: string | undefined,\n  extensionContext: vscode.ExtensionContext,\n): void {\n  configureClaude(apiKey, apiUrl, teamId, projectId, rootPath, hmacSecret, extensionContext);\n  configureCursor(apiKey, apiUrl, teamId, projectId, rootPath, hmacSecret, extensionContext);\n  configureCopilot(apiKey, apiUrl, teamId, projectId, rootPath, hmacSecret, extensionContext);\n  configureWindsurf(apiKey, apiUrl, teamId, extensionContext);\n  configureAntigravity(apiKey, apiUrl, teamId, projectId, extensionContext);\n}\n\n/* \u2500\u2500 Internal helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\nfunction buildMcpEnv(\n  apiKey: string,\n  apiUrl: string,\n  teamId: string,\n  projectId?: string,\n  hmacSecret?: string,\n): Record<string, string> {\n  const env: Record<string, string> = {\n    CONTOX_API_KEY: apiKey,\n    CONTOX_API_URL: apiUrl,\n    CONTOX_TEAM_ID: teamId,\n  };\n  if (projectId) { env['CONTOX_PROJECT_ID'] = projectId; }\n  if (hmacSecret) { env['CONTOX_HMAC_SECRET'] = hmacSecret; }\n  return env;\n}\n\n/** Merge a contox MCP server into an existing config without overwriting other servers. */\nfunction mergeServerConfig(\n  configPath: string,\n  serverKey: string,\n  serverConfig: Record<string, unknown>,\n  serversField: string = 'mcpServers',\n): void {\n  let existing: Record<string, unknown> = {};\n  try {\n    existing = JSON.parse(fs.readFileSync(configPath, 'utf-8')) as Record<string, unknown>;\n  } catch {\n    // File doesn't exist or invalid JSON \u2014 start fresh\n  }\n\n  const existingServers = (existing[serversField] ?? {}) as Record<string, unknown>;\n  const merged = {\n    ...existing,\n    [serversField]: { ...existingServers, [serverKey]: serverConfig },\n  };\n  fs.writeFileSync(configPath, JSON.stringify(merged, null, 2) + '\\n');\n}\n\nfunction configureClaude(\n  apiKey: string,\n  apiUrl: string,\n  teamId: string,\n  projectId: string,\n  rootPath: string,\n  hmacSecret: string | undefined,\n  extensionContext: vscode.ExtensionContext,\n): void {\n  const mcpServerPath = getMcpServerPath(extensionContext);\n  const env = buildMcpEnv(apiKey, apiUrl, teamId, projectId, hmacSecret);\n\n  mergeServerConfig(\n    path.join(rootPath, '.mcp.json'),\n    'contox',\n    { command: 'node', args: [mcpServerPath], env },\n  );\n}\n\nfunction configureCursor(\n  apiKey: string,\n  apiUrl: string,\n  teamId: string,\n  projectId: string,\n  rootPath: string,\n  hmacSecret: string | undefined,\n  extensionContext: vscode.ExtensionContext,\n): void {\n  const cursorDir = path.join(rootPath, '.cursor');\n  if (!fs.existsSync(cursorDir)) { fs.mkdirSync(cursorDir, { recursive: true }); }\n\n  const mcpServerPath = getMcpServerPath(extensionContext);\n  const env = buildMcpEnv(apiKey, apiUrl, teamId, projectId, hmacSecret);\n\n  mergeServerConfig(\n    path.join(cursorDir, 'mcp.json'),\n    'contox',\n    { command: 'node', args: [mcpServerPath], env },\n  );\n}\n\nfunction configureCopilot(\n  apiKey: string,\n  apiUrl: string,\n  teamId: string,\n  projectId: string,\n  rootPath: string,\n  hmacSecret: string | undefined,\n  extensionContext: vscode.ExtensionContext,\n): void {\n  const vscodeDir = path.join(rootPath, '.vscode');\n  if (!fs.existsSync(vscodeDir)) { fs.mkdirSync(vscodeDir, { recursive: true }); }\n\n  const mcpServerPath = getMcpServerPath(extensionContext);\n  const env = buildMcpEnv(apiKey, apiUrl, teamId, projectId, hmacSecret);\n\n  // VS Code Copilot uses \"servers\" key (not \"mcpServers\") and requires type: 'stdio'\n  mergeServerConfig(\n    path.join(vscodeDir, 'mcp.json'),\n    'contox',\n    { type: 'stdio', command: 'node', args: [mcpServerPath], env },\n    'servers',\n  );\n}\n\nfunction configureWindsurf(\n  apiKey: string,\n  apiUrl: string,\n  teamId: string,\n  extensionContext: vscode.ExtensionContext,\n): void {\n  // Windsurf uses a global config \u2014 no CONTOX_PROJECT_ID (resolved from .contox.json in cwd)\n  const windsurfDir = path.join(os.homedir(), '.codeium', 'windsurf');\n  if (!fs.existsSync(windsurfDir)) { fs.mkdirSync(windsurfDir, { recursive: true }); }\n\n  const mcpServerPath = getMcpServerPath(extensionContext);\n  const env = buildMcpEnv(apiKey, apiUrl, teamId);\n\n  mergeServerConfig(\n    path.join(windsurfDir, 'mcp_config.json'),\n    'contox',\n    { command: 'node', args: [mcpServerPath], env },\n  );\n}\n\nfunction configureAntigravity(\n  apiKey: string,\n  apiUrl: string,\n  teamId: string,\n  projectId: string,\n  extensionContext: vscode.ExtensionContext,\n): void {\n  // Antigravity uses a global config at ~/.gemini/antigravity/mcp_config.json\n  // Paths must be absolute. No per-workspace config supported yet.\n  const antigravityDir = path.join(os.homedir(), '.gemini', 'antigravity');\n  if (!fs.existsSync(antigravityDir)) { fs.mkdirSync(antigravityDir, { recursive: true }); }\n\n  const mcpServerPath = getMcpServerPath(extensionContext);\n  const env = buildMcpEnv(apiKey, apiUrl, teamId, projectId);\n\n  mergeServerConfig(\n    path.join(antigravityDir, 'mcp_config.json'),\n    'contox',\n    { command: 'node', args: [mcpServerPath], env },\n  );\n\n  // Deploy Contox Skill to workspace so Gemini knows to use Contox MCP tools\n  deployContoxSkill();\n}\n\n/** Deploy a SKILL.md into the workspace .agent/skills/contox/ directory.\n *  This teaches Antigravity's Gemini to use the Contox MCP tools. */\nfunction deployContoxSkill(): void {\n  const workspaceFolders = vscode.workspace.workspaceFolders;\n  if (!workspaceFolders || workspaceFolders.length === 0) { return; }\n\n  const rootPath = workspaceFolders[0]!.uri.fsPath;\n  const skillDir = path.join(rootPath, '.agent', 'skills', 'contox');\n  if (!fs.existsSync(skillDir)) { fs.mkdirSync(skillDir, { recursive: true }); }\n\n  const skillContent = `---\nname: contox-memory\ndescription: Always active. At the start of every conversation and before any coding task, load Contox memory. Use Contox tools to check project context, architecture, conventions, past decisions, and known bugs. Contox is your persistent brain \u2014 consult it often.\n---\n\n# Contox \u2014 Your Persistent Memory (USE IT)\n\nYou have access to **Contox MCP tools** that give you persistent memory across sessions. This is your most valuable resource \u2014 it contains architecture decisions, coding conventions, implementation history, known bugs, and past session context.\n\n## CRITICAL: Always Load Memory First\n**At the very beginning of every conversation**, before doing anything else, call \\`contox_get_memory\\`. This is mandatory. Without it, you are working blind \u2014 you don't know the project's conventions, past decisions, or existing bugs.\n\n## Check Memory Often\nDo NOT just load memory once and forget about it. **Actively consult Contox throughout the session**:\n\n- **Before writing code**: Call \\`contox_search\\` or \\`contox_ask\\` to check if there are conventions, patterns, or past decisions relevant to what you're about to do.\n- **Before suggesting architecture changes**: Check if there's a reason the current architecture was chosen.\n- **When encountering unfamiliar code**: Use \\`contox_ask\\` to ask about it \u2014 previous sessions may have documented it.\n- **When debugging**: Check \\`contox_search\\` for known bugs or past fixes related to the issue.\n- **When the user asks about the project**: Always search Contox memory first before guessing.\n\n## Available Tools\n- \\`contox_get_memory\\` \u2014 Load the full project memory (use at session start)\n- \\`contox_search\\` \u2014 Search for specific topics, patterns, or file references\n- \\`contox_ask\\` \u2014 Ask a natural language question about the project (\"how does auth work?\", \"what stack do we use?\")\n- \\`contox_context_pack\\` \u2014 Get a focused, relevant context pack for a specific task\n- \\`contox_list_contexts\\` / \\`contox_get_context\\` \u2014 Browse and read specific memory items\n- \\`contox_create_context\\` / \\`contox_update_context\\` \u2014 Store new knowledge\n- \\`contox_scan\\` \u2014 Scan the codebase to extract architecture and structure\n\n## Saving \u2014 USER-INITIATED ONLY\n- **NEVER** call \\`contox_save_session\\` automatically or proactively\n- Only save when the user explicitly asks (e.g. \"save\", \"save session\", \"contox save\")\n- When saving, provide a summary and categorized changes (architecture, conventions, implementation, decisions, bugs, todo)\n`;\n\n  fs.writeFileSync(path.join(skillDir, 'SKILL.md'), skillContent, 'utf-8');\n}\n\n/* \u2500\u2500 Webview HTML \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n\nfunction getWebviewContent(): string {\n  return /*html*/ `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>Contox Setup</title>\n<style>\n  :root {\n    --bg: #0A0A0B;\n    --surface: #111113;\n    --border: rgba(255,255,255,0.06);\n    --text: #FFFFFF;\n    --text-muted: #6B6B70;\n    --text-dim: #4A4A4E;\n    --orange: #FF5C00;\n    --orange-light: #FF8A4C;\n    --green: #22C55E;\n    --red: #EF4444;\n    --radius: 12px;\n  }\n\n  * { margin: 0; padding: 0; box-sizing: border-box; }\n\n  body {\n    background: var(--bg);\n    color: var(--text);\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    min-height: 100vh;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 2rem;\n  }\n\n  .wizard {\n    max-width: 520px;\n    width: 100%;\n  }\n\n  .step { display: none; }\n  .step.active { display: block; }\n\n  .logo {\n    text-align: center;\n    margin-bottom: 2rem;\n  }\n\n  .logo h1 {\n    font-size: 1.75rem;\n    font-weight: 700;\n    background: linear-gradient(135deg, var(--orange), var(--orange-light));\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n  }\n\n  .logo p {\n    color: var(--text-muted);\n    margin-top: 0.5rem;\n    font-size: 0.9rem;\n  }\n\n  .card {\n    background: var(--surface);\n    border: 1px solid var(--border);\n    border-radius: 16px;\n    padding: 1.5rem;\n    margin-bottom: 1rem;\n  }\n\n  .step-indicator {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: center;\n    margin-bottom: 1.5rem;\n  }\n\n  .step-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n    background: var(--text-dim);\n    transition: all 0.3s;\n  }\n  .step-dot.active {\n    background: var(--orange);\n    width: 24px;\n    border-radius: 4px;\n  }\n  .step-dot.done { background: var(--green); }\n\n  h2 {\n    font-size: 1.2rem;\n    font-weight: 600;\n    margin-bottom: 0.5rem;\n  }\n\n  p.desc {\n    color: var(--text-muted);\n    font-size: 0.85rem;\n    margin-bottom: 1.25rem;\n    line-height: 1.5;\n  }\n\n  input[type=\"text\"], input[type=\"password\"] {\n    width: 100%;\n    padding: 0.75rem 1rem;\n    background: rgba(255,255,255,0.02);\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    color: var(--text);\n    font-size: 0.9rem;\n    outline: none;\n    transition: border-color 0.2s;\n  }\n  input:focus {\n    border-color: rgba(255,92,0,0.5);\n    box-shadow: 0 0 0 2px rgba(255,92,0,0.15);\n  }\n  input::placeholder { color: var(--text-dim); }\n\n  .input-group {\n    margin-bottom: 1rem;\n  }\n  .input-group label {\n    display: block;\n    font-size: 0.8rem;\n    font-weight: 500;\n    margin-bottom: 0.4rem;\n    color: var(--text-muted);\n  }\n\n  .btn {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.5rem;\n    padding: 0.7rem 1.5rem;\n    border-radius: var(--radius);\n    font-size: 0.9rem;\n    font-weight: 600;\n    cursor: pointer;\n    border: none;\n    transition: all 0.2s;\n    width: 100%;\n  }\n\n  .btn-primary {\n    background: linear-gradient(135deg, var(--orange), var(--orange-light));\n    color: white;\n    box-shadow: 0 0 20px rgba(255,92,0,0.3);\n  }\n  .btn-primary:hover {\n    box-shadow: 0 0 30px rgba(255,92,0,0.5);\n    transform: translateY(-1px);\n  }\n  .btn-primary:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n    transform: none;\n    box-shadow: none;\n  }\n\n  .btn-secondary {\n    background: rgba(255,255,255,0.06);\n    color: var(--text);\n    border: 1px solid var(--border);\n  }\n  .btn-secondary:hover { background: rgba(255,255,255,0.1); }\n\n  .btn-row {\n    display: flex;\n    gap: 0.75rem;\n    margin-top: 1.25rem;\n  }\n  .btn-row .btn { flex: 1; }\n\n  .error {\n    color: var(--red);\n    font-size: 0.8rem;\n    margin-top: 0.5rem;\n    display: none;\n  }\n  .error.show { display: block; }\n\n  .success {\n    color: var(--green);\n    font-size: 0.85rem;\n    text-align: center;\n    padding: 0.5rem;\n  }\n\n  /* Project list */\n  .project-list {\n    max-height: 250px;\n    overflow-y: auto;\n    margin-bottom: 1rem;\n  }\n\n  .project-item {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 0.75rem 1rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    margin-bottom: 0.5rem;\n    cursor: pointer;\n    transition: all 0.2s;\n  }\n  .project-item:hover {\n    background: rgba(255,92,0,0.05);\n    border-color: rgba(255,92,0,0.3);\n  }\n  .project-item.selected {\n    background: rgba(255,92,0,0.1);\n    border-color: var(--orange);\n  }\n  .project-item .name { font-weight: 500; font-size: 0.9rem; }\n  .project-item .meta { color: var(--text-dim); font-size: 0.75rem; }\n\n  /* AI tool checkboxes */\n  .ai-tools {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: 0.5rem;\n    margin-bottom: 1rem;\n  }\n\n  .ai-tool {\n    display: flex;\n    align-items: center;\n    gap: 0.6rem;\n    padding: 0.75rem 1rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    cursor: pointer;\n    transition: all 0.2s;\n    user-select: none;\n  }\n  .ai-tool:hover { background: rgba(255,255,255,0.03); }\n  .ai-tool.checked {\n    background: rgba(255,92,0,0.08);\n    border-color: rgba(255,92,0,0.4);\n  }\n\n  .ai-tool input { display: none; }\n  .ai-tool .checkbox {\n    width: 18px;\n    height: 18px;\n    border: 2px solid var(--text-dim);\n    border-radius: 4px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    flex-shrink: 0;\n    transition: all 0.2s;\n  }\n  .ai-tool.checked .checkbox {\n    background: var(--orange);\n    border-color: var(--orange);\n  }\n  .ai-tool.checked .checkbox::after {\n    content: '\\\\2713';\n    color: white;\n    font-size: 12px;\n    font-weight: bold;\n  }\n  .ai-tool .info .name { font-size: 0.85rem; font-weight: 500; }\n  .ai-tool .info .desc { font-size: 0.7rem; color: var(--text-dim); }\n\n  .config-results {\n    margin-top: 1rem;\n  }\n  .config-results li {\n    color: var(--green);\n    font-size: 0.8rem;\n    margin-bottom: 0.25rem;\n    list-style: none;\n    padding-left: 1rem;\n  }\n  .config-results li::before {\n    content: '\\\\2713 ';\n    margin-left: -1rem;\n  }\n\n  .spinner {\n    display: inline-block;\n    width: 16px;\n    height: 16px;\n    border: 2px solid rgba(255,255,255,0.3);\n    border-top-color: white;\n    border-radius: 50%;\n    animation: spin 0.6s linear infinite;\n  }\n  @keyframes spin { to { transform: rotate(360deg); } }\n\n  .final-card {\n    text-align: center;\n    padding: 2rem;\n  }\n  .final-card .icon {\n    font-size: 3rem;\n    margin-bottom: 1rem;\n  }\n  .final-card h2 { margin-bottom: 0.75rem; }\n  .final-card p { color: var(--text-muted); font-size: 0.85rem; line-height: 1.6; margin-bottom: 1.5rem; }\n\n  .help-link {\n    color: var(--orange);\n    text-decoration: none;\n    font-size: 0.8rem;\n    margin-top: 1rem;\n    display: block;\n    text-align: center;\n  }\n</style>\n</head>\n<body>\n<div class=\"wizard\">\n  <div class=\"logo\">\n    <h1>Contox</h1>\n    <p>Persistent AI memory for your projects</p>\n  </div>\n\n  <div class=\"step-indicator\">\n    <div class=\"step-dot active\" data-step=\"0\"></div>\n    <div class=\"step-dot\" data-step=\"1\"></div>\n    <div class=\"step-dot\" data-step=\"2\"></div>\n    <div class=\"step-dot\" data-step=\"3\"></div>\n    <div class=\"step-dot\" data-step=\"4\"></div>\n  </div>\n\n  <!-- Step 0: Welcome + Login -->\n  <div class=\"step active\" data-step=\"0\">\n    <div class=\"card\">\n      <h2>Connect your account</h2>\n      <p class=\"desc\">Enter your API key from the Contox dashboard. You can find it at Settings &gt; API Keys.</p>\n      <div class=\"input-group\">\n        <label>API Key</label>\n        <input type=\"password\" id=\"apiKey\" placeholder=\"ctx_xxxxxxxxxxxxxxxx\" />\n      </div>\n      <div class=\"error\" id=\"loginError\"></div>\n      <button class=\"btn btn-primary\" id=\"loginBtn\" onclick=\"doLogin()\">\n        Connect\n      </button>\n    </div>\n  </div>\n\n  <!-- Step 1: Select Team -->\n  <div class=\"step\" data-step=\"1\">\n    <div class=\"card\">\n      <h2>Your organization</h2>\n      <p class=\"desc\">Select the organization you want to connect this workspace to.</p>\n      <div class=\"project-list\" id=\"teamList\">\n        <p style=\"color: var(--text-dim); text-align: center; padding: 2rem;\"><span class=\"spinner\"></span> Loading teams...</p>\n      </div>\n      <div class=\"error\" id=\"teamError\"></div>\n      <button class=\"btn btn-primary\" id=\"teamBtn\" disabled onclick=\"confirmTeam()\">\n        Continue\n      </button>\n    </div>\n  </div>\n\n  <!-- Step 2: Select Project -->\n  <div class=\"step\" data-step=\"2\">\n    <div class=\"card\">\n      <h2>Select a project</h2>\n      <p class=\"desc\">Link this workspace to a Contox project. Your AI memory will be stored here.</p>\n      <div class=\"project-list\" id=\"projectList\">\n        <p style=\"color: var(--text-dim); text-align: center; padding: 2rem;\">Loading projects...</p>\n      </div>\n      <div class=\"error\" id=\"projectError\"></div>\n      <div class=\"btn-row\">\n        <button class=\"btn btn-secondary\" onclick=\"goStep(1)\">Back</button>\n        <button class=\"btn btn-primary\" id=\"selectProjectBtn\" disabled onclick=\"selectProject()\">\n          Link project\n        </button>\n      </div>\n    </div>\n  </div>\n\n  <!-- Step 3: AI Tools -->\n  <div class=\"step\" data-step=\"3\">\n    <div class=\"card\">\n      <h2>Configure your AI tools</h2>\n      <p class=\"desc\">Select which AI coding tools you use. We'll auto-configure each one to use Contox memory.</p>\n      <div class=\"ai-tools\">\n        <label class=\"ai-tool\" onclick=\"toggleTool(this)\">\n          <input type=\"checkbox\" value=\"claude\" checked />\n          <div class=\"checkbox\"></div>\n          <div class=\"info\">\n            <div class=\"name\">Claude Code</div>\n            <div class=\"desc\">.mcp.json</div>\n          </div>\n        </label>\n        <label class=\"ai-tool\" onclick=\"toggleTool(this)\">\n          <input type=\"checkbox\" value=\"cursor\" />\n          <div class=\"checkbox\"></div>\n          <div class=\"info\">\n            <div class=\"name\">Cursor</div>\n            <div class=\"desc\">.cursor/mcp.json</div>\n          </div>\n        </label>\n        <label class=\"ai-tool\" onclick=\"toggleTool(this)\">\n          <input type=\"checkbox\" value=\"copilot\" />\n          <div class=\"checkbox\"></div>\n          <div class=\"info\">\n            <div class=\"name\">GitHub Copilot</div>\n            <div class=\"desc\">.vscode/mcp.json</div>\n          </div>\n        </label>\n        <label class=\"ai-tool\" onclick=\"toggleTool(this)\">\n          <input type=\"checkbox\" value=\"windsurf\" />\n          <div class=\"checkbox\"></div>\n          <div class=\"info\">\n            <div class=\"name\">Windsurf</div>\n            <div class=\"desc\">global MCP config</div>\n          </div>\n        </label>\n        <label class=\"ai-tool\" onclick=\"toggleTool(this)\">\n          <input type=\"checkbox\" value=\"antigravity\" />\n          <div class=\"checkbox\"></div>\n          <div class=\"info\">\n            <div class=\"name\">Antigravity</div>\n            <div class=\"desc\">~/.gemini/antigravity/</div>\n          </div>\n        </label>\n      </div>\n      <ul class=\"config-results\" id=\"configResults\"></ul>\n      <button class=\"btn btn-primary\" id=\"configBtn\" onclick=\"configureAI()\">\n        Configure selected tools\n      </button>\n    </div>\n  </div>\n\n  <!-- Step 4: Done -->\n  <div class=\"step\" data-step=\"4\">\n    <div class=\"card final-card\">\n      <div class=\"icon\">&#x1f680;</div>\n      <h2>You're all set!</h2>\n      <p>\n        Your AI now has persistent memory.<br>\n        It will remember everything across sessions.<br><br>\n        <strong>How it works:</strong><br>\n        Session start: AI loads context automatically<br>\n        Session end: AI saves what was done\n      </p>\n      <button class=\"btn btn-primary\" onclick=\"runScan()\">\n        Run first scan\n      </button>\n      <div style=\"margin-top: 0.75rem;\">\n        <button class=\"btn btn-secondary\" onclick=\"finish()\">\n          Skip &amp; finish\n        </button>\n      </div>\n    </div>\n  </div>\n</div>\n\n<script>\n  const vscode = acquireVsCodeApi();\n  let currentStep = 0;\n  let selectedTeamId = null;\n  let selectedTeamName = null;\n  let selectedProjectId = null;\n  let selectedProjectName = null;\n\n  function goStep(n) {\n    document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));\n    document.querySelector('.step[data-step=\"' + n + '\"]').classList.add('active');\n\n    document.querySelectorAll('.step-dot').forEach((dot, i) => {\n      dot.classList.remove('active', 'done');\n      if (i < n) dot.classList.add('done');\n      if (i === n) dot.classList.add('active');\n    });\n\n    currentStep = n;\n  }\n\n  function doLogin() {\n    const key = document.getElementById('apiKey').value.trim();\n    if (!key) return;\n\n    const btn = document.getElementById('loginBtn');\n    btn.innerHTML = '<span class=\"spinner\"></span> Connecting...';\n    btn.disabled = true;\n    document.getElementById('loginError').classList.remove('show');\n\n    vscode.postMessage({ type: 'login', apiKey: key });\n  }\n\n  function loadTeams() {\n    vscode.postMessage({ type: 'loadTeams' });\n  }\n\n  function pickTeam(el, id, name) {\n    document.querySelectorAll('#teamList .project-item').forEach(e => e.classList.remove('selected'));\n    el.classList.add('selected');\n    selectedTeamId = id;\n    selectedTeamName = name;\n    document.getElementById('teamBtn').disabled = false;\n  }\n\n  function confirmTeam() {\n    if (!selectedTeamId) return;\n\n    const btn = document.getElementById('teamBtn');\n    btn.innerHTML = '<span class=\"spinner\"></span> Loading projects...';\n    btn.disabled = true;\n\n    vscode.postMessage({ type: 'loadProjects', teamId: selectedTeamId });\n  }\n\n  function selectProject() {\n    if (!selectedProjectId) return;\n\n    const btn = document.getElementById('selectProjectBtn');\n    btn.innerHTML = '<span class=\"spinner\"></span> Linking...';\n    btn.disabled = true;\n\n    vscode.postMessage({\n      type: 'selectProject',\n      teamId: selectedTeamId,\n      projectId: selectedProjectId,\n      projectName: selectedProjectName,\n    });\n  }\n\n  function toggleTool(el) {\n    const input = el.querySelector('input');\n    input.checked = !input.checked;\n    el.classList.toggle('checked', input.checked);\n  }\n\n  function configureAI() {\n    const tools = [];\n    document.querySelectorAll('.ai-tool input:checked').forEach(input => {\n      tools.push(input.value);\n    });\n\n    if (tools.length === 0) {\n      goStep(4);\n      return;\n    }\n\n    const btn = document.getElementById('configBtn');\n    btn.innerHTML = '<span class=\"spinner\"></span> Configuring...';\n    btn.disabled = true;\n\n    vscode.postMessage({ type: 'configureAI', aiTools: tools });\n  }\n\n  function runScan() {\n    vscode.postMessage({ type: 'runScan' });\n    finish();\n  }\n\n  function finish() {\n    vscode.postMessage({ type: 'finish' });\n  }\n\n  // Initialize checked state visual\n  document.querySelectorAll('.ai-tool').forEach(el => {\n    const input = el.querySelector('input');\n    if (input.checked) el.classList.add('checked');\n  });\n\n  // Handle messages from the extension\n  window.addEventListener('message', event => {\n    const msg = event.data;\n\n    switch (msg.type) {\n      case 'alreadyLoggedIn':\n        goStep(1);\n        loadTeams();\n        break;\n\n      case 'loginResult':\n        const loginBtn = document.getElementById('loginBtn');\n        loginBtn.disabled = false;\n        if (msg.success) {\n          loginBtn.innerHTML = '&#x2713; Connected';\n          setTimeout(() => {\n            goStep(1);\n            loadTeams();\n          }, 500);\n        } else {\n          loginBtn.innerHTML = 'Connect';\n          const err = document.getElementById('loginError');\n          err.textContent = msg.error || 'Login failed';\n          err.classList.add('show');\n        }\n        break;\n\n      case 'teamsLoaded': {\n        const teamList = document.getElementById('teamList');\n        if (msg.success) {\n          const teams = msg.teams || [];\n          if (teams.length === 0) {\n            teamList.innerHTML = '<p style=\"color: var(--text-dim); text-align: center; padding: 1rem;\">No organizations found. Create one on the dashboard first.</p>';\n          } else {\n            teamList.innerHTML = teams.map(t =>\n              '<div class=\"project-item\" onclick=\"pickTeam(this, \\\\'' + t.id + '\\\\', \\\\'' + t.name.replace(/'/g, \"\\\\\\\\'\") + '\\\\')\">' +\n              '<div class=\"name\">' + t.name + '</div>' +\n              '<div class=\"meta\">' + (t.members || 0) + ' members</div>' +\n              '</div>'\n            ).join('');\n          }\n        } else {\n          teamList.innerHTML = '<p style=\"color: var(--red); text-align: center; padding: 1rem;\">' + (msg.error || 'Failed to load teams') + '</p>';\n        }\n        break;\n      }\n\n      case 'projectsLoaded':\n        const teamBtn = document.getElementById('teamBtn');\n        teamBtn.disabled = false;\n        teamBtn.innerHTML = 'Continue';\n\n        if (msg.success) {\n          const list = document.getElementById('projectList');\n          const projects = msg.projects || [];\n\n          if (projects.length === 0) {\n            list.innerHTML = '<p style=\"color: var(--text-dim); text-align: center; padding: 1rem;\">No projects found. Create one on the dashboard first.</p>';\n          } else {\n            list.innerHTML = projects.map(p =>\n              '<div class=\"project-item\" onclick=\"pickProject(this, \\\\'' + p.id + '\\\\', \\\\'' + p.name.replace(/'/g, \"\\\\\\\\'\") + '\\\\')\">' +\n              '<div class=\"name\">' + p.name + '</div>' +\n              '<div class=\"meta\">' + p.contextsCount + ' contexts</div>' +\n              '</div>'\n            ).join('');\n          }\n          goStep(2);\n        } else {\n          const err = document.getElementById('teamError');\n          err.textContent = msg.error || 'Failed to load projects';\n          err.classList.add('show');\n        }\n        break;\n\n      case 'projectSelected':\n        if (msg.success) {\n          goStep(3);\n        } else {\n          const err = document.getElementById('projectError');\n          err.textContent = msg.error || 'Failed';\n          err.classList.add('show');\n          const btn = document.getElementById('selectProjectBtn');\n          btn.disabled = false;\n          btn.innerHTML = 'Link project';\n        }\n        break;\n\n      case 'aiConfigured':\n        const configBtn = document.getElementById('configBtn');\n        configBtn.disabled = false;\n        configBtn.innerHTML = 'Configure selected tools';\n\n        const results = document.getElementById('configResults');\n        results.innerHTML = (msg.results || []).map(r => '<li>' + r + '</li>').join('');\n\n        setTimeout(() => goStep(4), 1000);\n        break;\n    }\n  });\n\n  function pickProject(el, id, name) {\n    document.querySelectorAll('.project-item').forEach(e => e.classList.remove('selected'));\n    el.classList.add('selected');\n    selectedProjectId = id;\n    selectedProjectName = name;\n    document.getElementById('selectProjectBtn').disabled = false;\n  }\n</script>\n</body>\n</html>`;\n}\n", "import * as vscode from 'vscode';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\nconst MCP_SERVER_FILENAME = 'mcp-server.cjs';\r\nconst VERSION_FILENAME = 'mcp-server.version';\r\n\r\n/**\r\n * Deploy the bundled MCP server to globalStorageUri.\r\n *\r\n * The extension ships with dist/mcp-server.cjs alongside dist/extension.js.\r\n * On activation, this copies it to globalStorage if the version has changed.\r\n * globalStorage is per-extension (shared across all workspaces).\r\n *\r\n * Returns the absolute path to the deployed mcp-server.cjs.\r\n */\r\nexport async function deployMcpServer(\r\n  context: vscode.ExtensionContext,\r\n): Promise<string> {\r\n  const extensionVersion = (context.extension.packageJSON as { version: string }).version;\r\n\r\n  // Ensure globalStorage directory exists\r\n  const globalStoragePath = context.globalStorageUri.fsPath;\r\n  if (!fs.existsSync(globalStoragePath)) {\r\n    fs.mkdirSync(globalStoragePath, { recursive: true });\r\n  }\r\n\r\n  const targetPath = path.join(globalStoragePath, MCP_SERVER_FILENAME);\r\n  const versionPath = path.join(globalStoragePath, VERSION_FILENAME);\r\n\r\n  if (shouldDeploy(targetPath, versionPath, extensionVersion)) {\r\n    // Source: the MCP server bundled inside the extension package\r\n    const sourcePath = path.join(\r\n      context.extensionUri.fsPath,\r\n      'dist',\r\n      MCP_SERVER_FILENAME,\r\n    );\r\n\r\n    if (!fs.existsSync(sourcePath)) {\r\n      throw new Error(\r\n        `MCP server bundle not found at ${sourcePath}. ` +\r\n        'The extension may not have been built correctly.',\r\n      );\r\n    }\r\n\r\n    // Atomic-ish copy: write to .tmp then rename\r\n    const tmpPath = targetPath + '.tmp';\r\n    fs.copyFileSync(sourcePath, tmpPath);\r\n    fs.renameSync(tmpPath, targetPath);\r\n\r\n    // Write version marker\r\n    fs.writeFileSync(versionPath, extensionVersion, 'utf-8');\r\n  }\r\n\r\n  return targetPath;\r\n}\r\n\r\nfunction shouldDeploy(\r\n  targetPath: string,\r\n  versionPath: string,\r\n  extensionVersion: string,\r\n): boolean {\r\n  if (!fs.existsSync(targetPath)) {\r\n    return true;\r\n  }\r\n  if (!fs.existsSync(versionPath)) {\r\n    return true;\r\n  }\r\n  try {\r\n    const deployedVersion = fs.readFileSync(versionPath, 'utf-8').trim();\r\n    return deployedVersion !== extensionVersion;\r\n  } catch {\r\n    return true;\r\n  }\r\n}\r\n\r\n/**\r\n * Get the absolute path where the MCP server is deployed.\r\n * Does NOT deploy \u2014 just returns the expected path.\r\n */\r\nexport function getMcpServerPath(context: vscode.ExtensionContext): string {\r\n  return path.join(context.globalStorageUri.fsPath, MCP_SERVER_FILENAME);\r\n}\r\n", "import * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nimport { ContoxClient } from '../api/client';\n\n/**\n * \"Contox: Reset / Logout\"\n *\n * Clears the stored API key from SecretStorage and removes .contox.json\n * from the workspace root. This allows the user to start fresh.\n */\nexport function registerResetCommand(client: ContoxClient): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.reset', async () => {\n    const confirm = await vscode.window.showWarningMessage(\n      'Contox: This will log you out and remove the workspace configuration. Continue?',\n      { modal: true },\n      'Reset',\n    );\n\n    if (confirm !== 'Reset') {\n      return;\n    }\n\n    // Clear API key from SecretStorage\n    await client.clearApiKey();\n\n    // Remove .contox.json from workspace root\n    const folders = vscode.workspace.workspaceFolders;\n    if (folders && folders.length > 0) {\n      const configPath = path.join(folders[0]!.uri.fsPath, '.contox.json');\n      try {\n        if (fs.existsSync(configPath)) {\n          fs.unlinkSync(configPath);\n        }\n      } catch {\n        // ignore\n      }\n    }\n\n    void vscode.window.showInformationMessage('Contox: Reset complete. Run \"Contox: Setup Wizard\" to reconfigure.');\n  });\n}\n", "import * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nimport { ContoxClient } from '../api/client';\nimport { getWorkspaceConfig } from '../extension';\nimport { injectAllRuleFiles } from '../lib/inject-rules';\n\n/**\n * \"Contox: Load Memory\"\n *\n * Fetches the compiled V2 brain document and writes it to .contox/memory.md.\n * Also injects Contox instructions into detected AI rule files so every\n * AI tool in the workspace automatically knows about the memory.\n */\nexport function registerLoadMemoryCommand(\n  client: ContoxClient,\n): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.loadMemory', async () => {\n    const config = getWorkspaceConfig();\n    if (!config) {\n      void vscode.window.showWarningMessage(\n        'Contox: No project linked. Connect via dashboard first.',\n      );\n      return;\n    }\n\n    const workspaceFolders = vscode.workspace.workspaceFolders;\n    if (!workspaceFolders || workspaceFolders.length === 0) {\n      return;\n    }\n\n    const rootPath = workspaceFolders[0]!.uri.fsPath;\n\n    // 1. Fetch brain\n    const result = await client.getBrain(config.projectId);\n    if (result.error) {\n      void vscode.window.showErrorMessage(`Contox: Failed to load memory \u2014 ${result.error}`);\n      return;\n    }\n\n    const brain = result.data;\n    if (!brain || !brain.document || brain.document.trim().length === 0) {\n      void vscode.window.showInformationMessage('Contox: Memory is empty \u2014 nothing to load yet.');\n      return;\n    }\n\n    // 2. Write .contox/memory.md\n    const contoxDir = path.join(rootPath, '.contox');\n    if (!fs.existsSync(contoxDir)) {\n      fs.mkdirSync(contoxDir, { recursive: true });\n    }\n\n    const memoryPath = path.join(contoxDir, 'memory.md');\n    fs.writeFileSync(memoryPath, brain.document, 'utf-8');\n\n    // Ensure .contox is in .gitignore\n    ensureGitignore(rootPath);\n\n    // 3. Inject instructions into AI rule files\n    const injected = injectAllRuleFiles(rootPath);\n\n    // 4. Notify\n    const injectedStr = injected.length > 0 ? ` \u2192 ${injected.join(', ')}` : '';\n    void vscode.window.showInformationMessage(\n      `Contox: Memory loaded (${String(brain.itemsLoaded)} items, ~${String(brain.tokenEstimate)} tokens)${injectedStr}`,\n    );\n  });\n}\n\n/**\n * Programmatic version (no notifications) for use after connect/sync.\n * Returns true on success.\n */\nexport async function loadMemorySilent(\n  client: ContoxClient,\n  rootPath: string,\n  projectId: string,\n): Promise<boolean> {\n  try {\n    const result = await client.getBrain(projectId);\n    if (result.error || !result.data?.document) {\n      return false;\n    }\n\n    const contoxDir = path.join(rootPath, '.contox');\n    if (!fs.existsSync(contoxDir)) {\n      fs.mkdirSync(contoxDir, { recursive: true });\n    }\n\n    fs.writeFileSync(path.join(contoxDir, 'memory.md'), result.data.document, 'utf-8');\n    ensureGitignore(rootPath);\n    injectAllRuleFiles(rootPath);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/** Add .contox/ to .gitignore if not already present */\nfunction ensureGitignore(rootPath: string): void {\n  const gitignorePath = path.join(rootPath, '.gitignore');\n  try {\n    let content = '';\n    if (fs.existsSync(gitignorePath)) {\n      content = fs.readFileSync(gitignorePath, 'utf-8');\n    }\n    if (!content.includes('.contox/')) {\n      const separator = content.length > 0 && !content.endsWith('\\n') ? '\\n' : '';\n      fs.writeFileSync(\n        gitignorePath,\n        content + separator + '\\n# Contox local memory\\n.contox/\\n',\n        'utf-8',\n      );\n    }\n  } catch {\n    // Non-critical\n  }\n}\n", "import * as fs from 'fs';\nimport * as path from 'path';\n\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * Marker-based injection into AI rule files\n *\n * Injects a Contox section between <!-- contox:start --> and <!-- contox:end -->\n * markers. User content outside the markers is NEVER touched.\n *\n * Supported AI tools:\n *   - Cursor       \u2192 .cursorrules\n *   - Copilot      \u2192 .github/copilot-instructions.md\n *   - Windsurf     \u2192 .windsurfrules\n *   - Cline        \u2192 .clinerules\n *   - Claude Code  \u2192 CLAUDE.md (skipped \u2014 handled by MCP server)\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\n\nconst MARKER_START = '<!-- contox:start -->';\nconst MARKER_END = '<!-- contox:end -->';\n\n/** The instruction block injected into each AI's rule file */\nconst CONTOX_INSTRUCTIONS = `# Contox \u2014 Project Memory\n\nYou have access to a persistent project memory that survives across sessions.\nThe file \\`.contox/memory.md\\` in this workspace contains architecture decisions,\nconventions, implementation history, bug fixes, and todos from all previous sessions.\n\n## MANDATORY: Read memory at session start\n- Read \\`.contox/memory.md\\` BEFORE starting any work\n- This is your primary source of truth about this project\n- Do NOT ask questions that are already answered in the memory\n\n## Active file context\n- \\`.contox/context.md\\` contains focused context relevant to your current file\n- This file updates automatically as you navigate the codebase\n- Use it for file-specific decisions, patterns, and conventions\n\n## Save your work at session end\n- Run: \\`contox save \"Brief summary of what you did\"\\`\n- For structured saves: \\`echo '{\"summary\":\"...\",\"changes\":[{\"category\":\"implementation\",\"title\":\"...\",\"content\":\"...\"}]}' | contox save --json\\`\n- Categories: architecture, conventions, implementation, decisions, bugs, todo`;\n\ninterface RuleTarget {\n  name: string;\n  relPath: string;\n  /** Also inject if this directory exists (even if the file doesn't) */\n  dirHint?: string;\n}\n\nconst TARGETS: RuleTarget[] = [\n  { name: 'Cursor', relPath: '.cursorrules', dirHint: '.cursor' },\n  { name: 'Copilot', relPath: path.join('.github', 'copilot-instructions.md'), dirHint: '.github' },\n  { name: 'Windsurf', relPath: '.windsurfrules' },\n  { name: 'Cline', relPath: '.clinerules' },\n];\n\n/**\n * Merge the Contox section into existing file content.\n * If markers already exist \u2192 replace between them.\n * If no markers \u2192 append at the end.\n * If file is empty \u2192 return just the section.\n */\nfunction mergeSection(existing: string, section: string): string {\n  const wrapped = `${MARKER_START}\\n${section}\\n${MARKER_END}`;\n\n  if (!existing.trim()) {\n    return wrapped + '\\n';\n  }\n\n  const startIdx = existing.indexOf(MARKER_START);\n  const endIdx = existing.indexOf(MARKER_END);\n\n  if (startIdx !== -1 && endIdx !== -1) {\n    const before = existing.slice(0, startIdx);\n    const after = existing.slice(endIdx + MARKER_END.length);\n    return before + wrapped + after;\n  }\n\n  const separator = existing.endsWith('\\n') ? '\\n' : '\\n\\n';\n  return existing + separator + wrapped + '\\n';\n}\n\n/**\n * Inject Contox instructions into all detected AI rule files.\n * Returns the list of AI tool names that were injected.\n */\nexport function injectAllRuleFiles(rootPath: string): string[] {\n  const injected: string[] = [];\n\n  for (const target of TARGETS) {\n    const filePath = path.join(rootPath, target.relPath);\n    const fileExists = fs.existsSync(filePath);\n    const dirExists = target.dirHint\n      ? fs.existsSync(path.join(rootPath, target.dirHint))\n      : false;\n\n    // Only inject if file exists OR its hint directory exists\n    if (!fileExists && !dirExists) {\n      continue;\n    }\n\n    try {\n      // Ensure parent directory exists\n      const parentDir = path.dirname(filePath);\n      if (!fs.existsSync(parentDir)) {\n        fs.mkdirSync(parentDir, { recursive: true });\n      }\n\n      const existing = fileExists ? fs.readFileSync(filePath, 'utf-8') : '';\n      const merged = mergeSection(existing, CONTOX_INSTRUCTIONS);\n      fs.writeFileSync(filePath, merged, 'utf-8');\n      injected.push(target.name);\n    } catch {\n      // Non-critical \u2014 skip this target\n    }\n  }\n\n  return injected;\n}\n", "import * as vscode from 'vscode';\n\nimport type { GitWatcher } from '../providers/git-watcher';\nimport { getWorkspaceConfig } from '../extension';\n\n/**\n * \"Contox: End Session & Start New\"\n *\n * Flushes pending capture events, closes the active session via the API,\n * and resets the buffer so the next activity starts a fresh session.\n */\nexport function registerEndSessionCommand(\n  gitWatcher: GitWatcher,\n): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.endSession', async () => {\n    const config = getWorkspaceConfig();\n    if (!config) {\n      void vscode.window.showWarningMessage(\n        'Contox: No project linked. Connect via dashboard first.',\n      );\n      return;\n    }\n\n    const result = await vscode.window.withProgress(\n      {\n        location: vscode.ProgressLocation.Notification,\n        title: 'Contox: Ending session\u2026',\n        cancellable: false,\n      },\n      async () => gitWatcher.endSession(),\n    );\n\n    if (result.closed) {\n      const msg = result.newSessionId\n        ? `Contox: Session closed \u2014 new session started.`\n        : `Contox: Session closed. Next activity will start a new session.`;\n      void vscode.window.showInformationMessage(msg);\n    } else {\n      void vscode.window.showWarningMessage(\n        'Contox: No active session found, or failed to close it.',\n      );\n    }\n  });\n}\n", "import * as vscode from 'vscode';\nimport type { StatusBarManager } from '../providers/status-bar';\nimport type { SessionWatcher } from '../providers/session-watcher';\nimport type { GitWatcher } from '../providers/git-watcher';\n\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * Desync / Connect \u2014 Temporarily pause and resume sync without logging out\n *\n * - contox.desync: Flush pending events, stop all watchers, show disconnected\n * - contox.connect: Re-start watchers, re-sync brain, restore normal status\n *\n * State is persisted in workspaceState so it survives VS Code restarts.\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\n\nconst STATE_KEY = 'contox.desynced';\n\nexport function isDesynced(context: vscode.ExtensionContext): boolean {\n  return context.workspaceState.get<boolean>(STATE_KEY, false);\n}\n\nexport function registerDesyncCommand(\n  statusBar: StatusBarManager,\n  sessionWatcher: SessionWatcher,\n  gitWatcher: GitWatcher,\n  context: vscode.ExtensionContext,\n): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.desync', async () => {\n    // Flush any pending captured events before disconnecting\n    await gitWatcher.flush();\n\n    // Stop watchers\n    sessionWatcher.stop();\n    gitWatcher.stop();\n\n    // Persist state\n    await context.workspaceState.update(STATE_KEY, true);\n\n    // Update status bar\n    statusBar.setDisconnected();\n\n    void vscode.window.showInformationMessage(\n      'Contox: Sync paused. Capture and polling stopped.',\n      'Reconnect',\n    ).then((action) => {\n      if (action === 'Reconnect') {\n        void vscode.commands.executeCommand('contox.connect');\n      }\n    });\n  });\n}\n\nexport function registerConnectCommand(\n  client: { getApiKey: () => Promise<string | null> },\n  statusBar: StatusBarManager,\n  sessionWatcher: SessionWatcher,\n  gitWatcher: GitWatcher,\n  context: vscode.ExtensionContext,\n  getProjectId: () => string | null,\n): vscode.Disposable {\n  return vscode.commands.registerCommand('contox.connect', async () => {\n    const projectId = getProjectId();\n    if (!projectId) {\n      void vscode.window.showWarningMessage(\n        'Contox: No project configured. Run \"Contox: Setup Wizard\" first.',\n      );\n      return;\n    }\n\n    const key = await client.getApiKey();\n    if (!key) {\n      void vscode.window.showWarningMessage(\n        'Contox: Not authenticated. Run \"Contox: Login\" first.',\n      );\n      return;\n    }\n\n    // Clear desynced state\n    await context.workspaceState.update(STATE_KEY, false);\n\n    // Restart watchers\n    sessionWatcher.start(projectId);\n    gitWatcher.start(projectId);\n\n    // Re-sync brain\n    statusBar.setSyncing();\n    await vscode.commands.executeCommand('contox.sync');\n\n    void vscode.window.showInformationMessage('Contox: Reconnected \u2014 sync resumed.');\n  });\n}\n", "import * as vscode from 'vscode';\nimport * as fs from 'fs';\nimport * as path from 'path';\n\nimport type { ContoxClient, SearchResult } from '../api/client';\n\n/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * Context Injector \u2014 Auto-inject relevant memory into .contox/context.md\n *\n * Watches active editor changes and debounces file-context queries.\n * When a file is opened/focused, searches the project memory for relevant\n * items and writes a focused context file that AI tools can reference.\n *\n * The injected file is at .contox/context.md \u2014 a lightweight, focused subset\n * of the brain relevant to the current working file. This supplements the\n * full .contox/memory.md with file-specific context.\n *\n * Rate limiting:\n *   - Debounce: 2s after editor change\n *   - Cache: Same file path \u2192 reuse results for 5 minutes\n *   - Minimum interval: 10s between API calls\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */\n\nconst DEBOUNCE_MS = 2000;\nconst CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\nconst MIN_INTERVAL_MS = 10 * 1000;   // 10s between API calls\nconst MAX_RESULTS = 8;\n\ninterface CacheEntry {\n  filePath: string;\n  results: SearchResult[];\n  timestamp: number;\n}\n\nexport class ContextInjector implements vscode.Disposable {\n  private readonly disposables: vscode.Disposable[] = [];\n  private debounceTimer: ReturnType<typeof setTimeout> | null = null;\n  private cache: CacheEntry | null = null;\n  private lastApiCall = 0;\n  private projectId: string | null = null;\n  private rootPath: string | null = null;\n  private enabled = true;\n\n  constructor(private readonly client: ContoxClient) {\n    // Watch active editor changes\n    this.disposables.push(\n      vscode.window.onDidChangeActiveTextEditor((editor) => {\n        if (editor && this.enabled && this.projectId) {\n          this.scheduleInjection(editor.document);\n        }\n      }),\n    );\n  }\n\n  /** Start watching for a specific project */\n  start(projectId: string): void {\n    this.projectId = projectId;\n\n    const workspaceFolders = vscode.workspace.workspaceFolders;\n    if (workspaceFolders && workspaceFolders.length > 0) {\n      this.rootPath = workspaceFolders[0]!.uri.fsPath;\n    }\n\n    // Inject for currently active editor\n    const activeEditor = vscode.window.activeTextEditor;\n    if (activeEditor) {\n      this.scheduleInjection(activeEditor.document);\n    }\n  }\n\n  /** Stop watching */\n  stop(): void {\n    this.projectId = null;\n    if (this.debounceTimer) {\n      clearTimeout(this.debounceTimer);\n      this.debounceTimer = null;\n    }\n  }\n\n  /** Toggle enabled state */\n  setEnabled(enabled: boolean): void {\n    this.enabled = enabled;\n    if (!enabled) {\n      this.stop();\n    }\n  }\n\n  private scheduleInjection(document: vscode.TextDocument): void {\n    // Skip non-file URIs (output panels, untitled, etc.)\n    if (document.uri.scheme !== 'file') { return; }\n\n    // Skip known non-code files\n    const ext = path.extname(document.fileName).toLowerCase();\n    const skipExts = new Set(['.md', '.json', '.lock', '.txt', '.log', '.env', '.csv', '.svg', '.png', '.jpg', '.gif']);\n    if (skipExts.has(ext)) { return; }\n\n    // Skip files in .contox directory\n    if (document.fileName.includes('.contox')) { return; }\n\n    // Debounce\n    if (this.debounceTimer) {\n      clearTimeout(this.debounceTimer);\n    }\n\n    this.debounceTimer = setTimeout(() => {\n      void this.injectForFile(document.fileName);\n    }, DEBOUNCE_MS);\n  }\n\n  private async injectForFile(filePath: string): Promise<void> {\n    if (!this.projectId || !this.rootPath) { return; }\n\n    // Check cache\n    if (this.cache && this.cache.filePath === filePath) {\n      const age = Date.now() - this.cache.timestamp;\n      if (age < CACHE_TTL_MS) {\n        return; // Already have fresh context for this file\n      }\n    }\n\n    // Rate limit\n    const now = Date.now();\n    if (now - this.lastApiCall < MIN_INTERVAL_MS) {\n      return;\n    }\n\n    // Build search query from file path\n    const relativePath = path.relative(this.rootPath, filePath).replace(/\\\\/g, '/');\n    const fileName = path.basename(filePath, path.extname(filePath));\n    const dirName = path.dirname(relativePath);\n\n    // Create a semantic query from the file context\n    const query = `${fileName} ${dirName.replace(/\\//g, ' ')}`.trim();\n\n    try {\n      this.lastApiCall = Date.now();\n      const result = await this.client.searchMemory(this.projectId, query, MAX_RESULTS);\n\n      if (result.error || !result.data) { return; }\n\n      const results = result.data.results;\n      if (results.length === 0) { return; }\n\n      // Cache the results\n      this.cache = { filePath, results, timestamp: Date.now() };\n\n      // Write context file\n      this.writeContextFile(relativePath, results);\n    } catch {\n      // Non-critical \u2014 don't interrupt user workflow\n    }\n  }\n\n  private writeContextFile(currentFile: string, results: SearchResult[]): void {\n    if (!this.rootPath) { return; }\n\n    const contoxDir = path.join(this.rootPath, '.contox');\n    if (!fs.existsSync(contoxDir)) {\n      fs.mkdirSync(contoxDir, { recursive: true });\n    }\n\n    const lines: string[] = [\n      '# Active Context',\n      '',\n      `> Auto-generated for: \\`${currentFile}\\``,\n      `> ${String(results.length)} relevant memory items found`,\n      '',\n    ];\n\n    for (const item of results) {\n      const sim = Math.round(item.similarity * 100);\n      lines.push(`## ${item.title}`);\n      lines.push(`> ${item.type} | ${sim}% match | ${item.schemaKey}`);\n      if (item.files.length > 0) {\n        lines.push(`> Files: ${item.files.slice(0, 3).join(', ')}`);\n      }\n      lines.push('');\n      // Truncate facts to keep context file small\n      const truncatedFacts = item.facts.length > 500\n        ? item.facts.slice(0, 500) + '...'\n        : item.facts;\n      lines.push(truncatedFacts);\n      lines.push('');\n    }\n\n    lines.push('---');\n    lines.push(`_Updated: ${new Date().toLocaleTimeString()} | Full memory: .contox/memory.md_`);\n\n    const contextPath = path.join(contoxDir, 'context.md');\n    fs.writeFileSync(contextPath, lines.join('\\n'), 'utf-8');\n  }\n\n  dispose(): void {\n    this.stop();\n    for (const d of this.disposables) {\n      d.dispose();\n    }\n  }\n}\n"],
  "mappings": "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AAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;A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",
  "names": ["extension_exports", "__export", "activate", "deactivate", "getWorkspaceConfig", "__toCommonJS", "vscode", "fs", "path", "crypto", "vscode", "detectIdeSource", "name", "ContoxClient", "secrets", "config", "key", "path", "options", "url", "response", "body", "err", "projectId", "all", "offset", "limit", "result", "batch", "_teamId", "id", "teamId", "description", "data", "contextId", "content", "query", "sessionId", "source", "event", "hmacSecret", "eventPayload", "timestamp", "nonce", "signature", "respBody", "vscode", "SCHEMA_ICONS", "nodeIcon", "node", "icon", "ContextItem", "collapsible", "ContextTreeProvider", "_client", "tree", "total", "element", "n", "vscode", "formatTimeAgo", "iso", "diff", "secs", "mins", "hours", "StatusBarManager", "ago", "pipeline", "completedSteps", "totalSteps", "status", "durationSecs", "eventCount", "time", "vscode", "SESSIONS_POLL_INTERVAL", "PIPELINE_POLL_INTERVAL", "JOB_LABELS", "SessionWatcher", "client", "statusBar", "watcher", "projectId", "SESSIONS_POLL_INTERVAL", "result", "sessions", "latest", "activeSession", "res", "session", "summaryText", "parsed", "shortSummary", "source", "action", "sessionId", "PIPELINE_POLL_INTERVAL", "jobs", "pipeline", "jobDetails", "j", "icon", "label", "JOB_LABELS", "failedJob", "errorMsg", "vscode", "import_child_process", "import_util", "execFileAsync", "IDLE_FLUSH_MS", "AUTO_FLUSH_INTERVAL_MS", "MAX_EVENTS_BEFORE_PROMPT", "MAX_PAYLOAD_SIZE_BEFORE_PROMPT", "MAX_DIFF_CHARS_PER_COMMIT", "DIFF_TIMEOUT_MS", "DIFF_EXCLUDE_PATTERNS", "GitWatcher", "client", "statusBar", "secrets", "projectId", "hmacSecret", "event", "result", "commitCount", "fileCount", "newSessionId", "createResult", "gitExtension", "git", "repo", "currentHead", "previousHead", "rootPath", "localRef", "remoteRef", "stdout", "fromSha", "toSha", "lines", "line", "sha", "message", "author", "timestamp", "filtered", "rawDiff", "sections", "kept", "section", "filePath", "pat", "filesChanged", "insertions", "deletions", "parts", "ins", "del", "file", "f", "diff", "commit", "doc", "relativePath", "isNew", "editor", "durationSecs", "folders", "patterns", "lower", "pattern", "dir", "fromSecrets", "fromSettings", "action", "vscode", "registerLoginCommand", "client", "key", "validation", "vscode", "fs", "path", "registerInitCommand", "client", "workspaceFolders", "rootPath", "configPath", "teamId", "projectsResult", "items", "p", "picked", "selectedProject", "config", "vscode", "registerSyncCommand", "client", "treeProvider", "statusBar", "config", "getWorkspaceConfig", "result", "tree", "itemsLoaded", "vscode", "registerCreateCommand", "client", "treeProvider", "statusBar", "config", "getWorkspaceConfig", "name", "description", "result", "brainResult", "vscode", "fs", "path", "os", "fs", "path", "MCP_SERVER_FILENAME", "VERSION_FILENAME", "deployMcpServer", "context", "extensionVersion", "globalStoragePath", "targetPath", "versionPath", "shouldDeploy", "sourcePath", "tmpPath", "getMcpServerPath", "currentPanel", "registerSetupWizardCommand", "client", "treeProvider", "statusBar", "context", "openSetupWizard", "getWebviewContent", "message", "handleMessage", "panel", "extensionContext", "post", "msg", "teamsResult", "t", "result", "p", "workspaceFolders", "rootPath", "configPath", "config", "hmacResult", "brainResult", "err", "tools", "results", "teamId", "projectId", "raw", "cfg", "apiKey", "apiUrl", "hmacSecret", "configureClaude", "configureCursor", "configureCopilot", "configureWindsurf", "configureAntigravity", "scanApiKey", "scanApiUrl", "contoxRcPath", "terminal", "configureAllMcp", "buildMcpEnv", "env", "mergeServerConfig", "serverKey", "serverConfig", "serversField", "existing", "existingServers", "merged", "mcpServerPath", "getMcpServerPath", "cursorDir", "vscodeDir", "windsurfDir", "antigravityDir", "deployContoxSkill", "skillDir", "vscode", "fs", "path", "registerResetCommand", "client", "folders", "configPath", "vscode", "fs", "path", "fs", "path", "MARKER_START", "MARKER_END", "CONTOX_INSTRUCTIONS", "TARGETS", "mergeSection", "existing", "section", "wrapped", "startIdx", "endIdx", "before", "after", "separator", "injectAllRuleFiles", "rootPath", "injected", "target", "filePath", "fileExists", "dirExists", "parentDir", "merged", "registerLoadMemoryCommand", "client", "config", "getWorkspaceConfig", "workspaceFolders", "rootPath", "result", "brain", "contoxDir", "memoryPath", "ensureGitignore", "injected", "injectAllRuleFiles", "injectedStr", "loadMemorySilent", "projectId", "gitignorePath", "content", "separator", "vscode", "registerEndSessionCommand", "gitWatcher", "getWorkspaceConfig", "result", "msg", "vscode", "STATE_KEY", "isDesynced", "context", "registerDesyncCommand", "statusBar", "sessionWatcher", "gitWatcher", "action", "registerConnectCommand", "client", "getProjectId", "projectId", "vscode", "fs", "path", "DEBOUNCE_MS", "CACHE_TTL_MS", "MIN_INTERVAL_MS", "MAX_RESULTS", "ContextInjector", "client", "editor", "projectId", "workspaceFolders", "activeEditor", "enabled", "document", "ext", "filePath", "relativePath", "fileName", "dirName", "query", "result", "results", "currentFile", "contoxDir", "lines", "item", "sim", "truncatedFacts", "contextPath", "d", "getWorkspaceConfig", "workspaceFolders", "rootPath", "configPath", "raw", "parsed", "teamId", "projectId", "projectName", "ContoxUriHandler", "client", "treeProvider", "statusBar", "sessionWatcher", "gitWatcher", "context", "mcpReady", "uri", "params", "token", "hmacSecret", "result", "action", "openSetupWizard", "rcPath", "apiUrl", "rcConfig", "configureAllMcp", "err", "loadMemorySilent", "projects", "pick", "p", "activate", "deployMcpServer", "ContoxClient", "ContextTreeProvider", "StatusBarManager", "SessionWatcher", "GitWatcher", "contextInjector", "ContextInjector", "treeView", "handledByUri", "uriHandler", "originalHandleUri", "registerLoginCommand", "registerInitCommand", "registerSyncCommand", "registerCreateCommand", "registerSetupWizardCommand", "registerResetCommand", "registerLoadMemoryCommand", "registerEndSessionCommand", "registerDesyncCommand", "registerConnectCommand", "r", "key", "config", "wsFolders", "isDesynced", "hmacResult", "mcpConfigPath", "needsMcpSetup", "args", "deactivate"]
}
